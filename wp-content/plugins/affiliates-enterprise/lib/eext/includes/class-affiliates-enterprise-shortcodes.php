<?php
 if ( !defined( 'ABSPATH' ) ) { exit; } class Affiliates_Enterprise_Shortcodes { public static function init() { add_shortcode( 'affiliates_tiers', array( __CLASS__, 'affiliates_tiers' ) ); add_shortcode( 'affiliates_campaigns', array( __CLASS__, 'affiliates_campaigns' ) ); add_shortcode( 'affiliates_manage_campaigns', array( __CLASS__, 'affiliates_manage_campaigns' ) ); add_shortcode( 'affiliates_pixel', array( __CLASS__, 'affiliates_pixel' ) ); } public static function affiliates_tiers( $IXAP31, $IXAP32 = null ) { $IXAP24 = shortcode_atts( array( 'link_to_user_url' => 'no', 'show_depth_title' => 'no', 'depth_title' => __( 'Depth %d', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'show_avatar' => 'yes', 'avatar_size' => 32, 'style' => '<style type="text/css">.branch {padding-left:1em;margin-right:1em;} .branch img.avatar {vertical-align:middle;padding:4px;}</style>', 'max_depth' => null, 'show_from_date' => 'no', 'show_thru_date' => 'no', 'since' => __( 'since %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'until' => __( 'until %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'show_email' => 'no', 'before_referrals' => '', 'after_referrals' => '', 'closed' => 'yes', 'accepted' => 'yes', 'pending' => 'no', 'rejected' => 'no' ), $IXAP31 ); $IXAP33 = $IXAP24['max_depth']; if ( $IXAP33 !== null ) { $IXAP33 = intval( $IXAP33 ); if ( $IXAP33 <= 0 ) { $IXAP33 = null; } } $IXAP24['max_depth'] = $IXAP33; $IXAP24['link_to_user_url'] = $IXAP24['link_to_user_url'] === 'yes'; $IXAP24['show_depth_title'] = $IXAP24['show_depth_title'] === 'yes'; $IXAP24['show_avatar'] = $IXAP24['show_avatar'] === 'yes'; $IXAP24['show_from_date'] = $IXAP24['show_from_date'] === 'yes'; $IXAP24['show_thru_date'] = $IXAP24['show_thru_date'] === 'yes'; $IXAP24['show_email'] = $IXAP24['show_email'] === 'yes'; $IXAP24['accepted'] = $IXAP24['accepted'] === 'yes'; $IXAP24['closed'] = $IXAP24['closed'] === 'yes'; $IXAP24['pending'] = $IXAP24['pending'] === 'yes'; $IXAP24['rejected'] = $IXAP24['rejected'] === 'yes'; $IXAP34 = ''; if ( $user_id = get_current_user_id() ) { if ( $affiliate_ids = affiliates_get_user_affiliate( $user_id ) ) { if ( count( $affiliate_ids ) > 0 ) { Affiliates_Multi_Tier::get_tree( $affiliate_ids, $IXAP35 ); self::render_tree( $affiliate_ids, $IXAP35, $IXAP34, $IXAP33, 0, $IXAP24 ); } } } $IXAP34 = apply_filters( 'affiliates_tiers_output', $IXAP34 ); return $IXAP34; } public static function render_tree( $IXAP36, &$IXAP35, &$IXAP34, $IXAP33 = null, $IXAP37 = 0, $IXAP24 = array() ) { global $affiliates_db; $referrals_table = $affiliates_db->get_tablename( 'referrals' ); $IXAP24 = shortcode_atts( array( 'link_to_user_url' => false, 'show_depth_title' => false, 'depth_title' => __( 'Depth %d', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'show_avatar' => true, 'avatar_size' => 32, 'style' => '.branch {padding-left:1em;margin-right:1em;} .branch img.avatar {vertical-align:middle;padding:4px;}', 'show_from_date' => false, 'show_thru_date' => false, 'since' => __( 'since %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'until' => __( 'until %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'show_email' => false, 'before_referrals' => '', 'after_referrals' => '', 'accepted' => true, 'closed' => true, 'pending' => false, 'rejected' => false ), $IXAP24 ); $statuses = array(); if ( $IXAP24['accepted'] ) { $statuses[] = "'" . AFFILIATES_REFERRAL_STATUS_ACCEPTED . "'"; } if ( $IXAP24['closed'] ) { $statuses[] = "'" . AFFILIATES_REFERRAL_STATUS_CLOSED . "'"; } if ( $IXAP24['pending'] ) { $statuses[] = "'" . AFFILIATES_REFERRAL_STATUS_PENDING . "'"; } if ( $IXAP24['rejected'] ) { $statuses[] = "'" . AFFILIATES_REFERRAL_STATUS_REJECTED . "'"; } if ( count( $statuses ) > 0 ) { $statuses = implode( ',', $statuses ); } else { return; } if ( !empty( $IXAP24['style'] ) ) { $IXAP34 .= '<style type="text/css">'; $IXAP34 .= $IXAP24['style']; $IXAP34 .= '</style>'; } $IXAP34 .= sprintf( '<div class="depth depth-%d %s">', $IXAP37, $IXAP37 % 2 ? 'odd' : 'even' ); if ( $IXAP24['show_depth_title'] && $IXAP37 > 0 ) { $IXAP34 .= '<span class="title">'; $IXAP34 .= sprintf( $IXAP24['depth_title'], $IXAP37 ); $IXAP34 .= '</span>'; } $IXAP34 .= '<ul class="branch">'; foreach( $IXAP35 as $affiliate_id => $nodes ) { $IXAP34 .= '<li>'; $affiliate = affiliates_get_affiliate( $affiliate_id ); if ( $affiliate ) { $user_id = affiliates_get_affiliate_user( $affiliate_id ); $IXAP34 .= '<div class="affiliate">'; if ( $IXAP24['show_avatar'] ) { $IXAP38 = ''; $IXAP39 = intval( $IXAP24['avatar_size'] ); if ( $user_id ) { $IXAP38 = get_avatar( $user_id, $IXAP39 ); } else if ( !empty( $affiliate['email'] ) ) { $IXAP38 = get_avatar( $affiliate['email'], $IXAP39 ); } $IXAP34 .= $IXAP38; } if ( $IXAP24['link_to_user_url'] && ( $user = get_user_by( 'id', $user_id ) ) && !empty( $user->user_url ) ) { $IXAP34 .= sprintf( '<a href="%s" title="%s">%s</a>', esc_attr( $user->user_url ), sprintf( __( 'Visit %s\'s website', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), wp_filter_nohtml_kses( $affiliate['name'] ) ), wp_filter_nohtml_kses( $affiliate['name'] ) ); } else { $IXAP34 .= wp_filter_nohtml_kses( $affiliate['name'] ); } $IXAP34 .= '</div>'; if ( $IXAP24['show_email'] && !empty( $affiliate['email'] ) ) { $IXAP34 .= '<div class="email">'; $IXAP34 .= sprintf( '<a href="mailto:%s">', esc_attr( $affiliate['email'] ) ); $IXAP34 .= wp_strip_all_tags( $affiliate['email'] ); $IXAP34 .= '</a>'; $IXAP34 .= '</div>'; } if ( $IXAP24['show_from_date'] ) { $IXAP34 .= '<div class="from_date">'; $IXAP34 .= sprintf( $IXAP24['since'], date_i18n( get_option( 'date_format' ), strtotime( $affiliate['from_date'] ) ) ); $IXAP34 .= '</div>'; } if ( $IXAP24['show_thru_date'] ) { if ( $affiliate['thru_date'] ) { $IXAP34 .= '<div class="thru_date">'; $IXAP34 .= sprintf( $IXAP24['until'], date_i18n( get_option( 'date_format' ), strtotime( $affiliate['thru_date'] ) ) ); $IXAP34 .= '</div>'; } } if ( count( $IXAP36 ) === 1 ) { $IXAP40 = "SELECT sum(amount) total, currency_id FROM $referrals_table " . "WHERE affiliate_id = %d " . "AND status IN ($statuses) " . "AND IFNULL(reference,post_id) IN " . "(SELECT IFNULL(reference,post_id) FROM $referrals_table WHERE affiliate_id = %d) " . "AND data LIKE '%%tier_level%%\"value\";i:%d%%' " . "GROUP BY currency_id"; $IXAP41 = $affiliates_db->get_objects( $IXAP40, intval( $IXAP36[0] ), intval( $affiliate_id ), intval( $IXAP37 ) ); if ( count( $IXAP41 ) > 0 ) { $IXAP34 .= '<div class="referrals">'; $IXAP34 .= stripslashes( wp_filter_kses( $IXAP24['before_referrals'] ) ); $IXAP34 .= '<ul>'; foreach( $IXAP41 as $IXAP42 ) { $IXAP34 .= '<li>' . sprintf( __( '%s %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), $IXAP42->total, $IXAP42->currency_id ) . '</li>'; } $IXAP34 .= '</ul>'; $IXAP34 .= stripslashes( wp_filter_kses( $IXAP24['after_referrals'] ) ); $IXAP34 .= '</div>'; } } } if ( !empty( $nodes ) ) { if ( $IXAP33 === null || $IXAP33 > 0 ) { if ( $IXAP37 === 0 ) { $new_base_affiliate_ids = array( $affiliate_id ); } else { $new_base_affiliate_ids = $IXAP36; } self::render_tree( $new_base_affiliate_ids, $nodes, $IXAP34, $IXAP33 === null ? null : $IXAP33 - 1, $IXAP37 + 1, $IXAP24 ); } } $IXAP34 .= '</li>'; } $IXAP34 .= '</ul>'; $IXAP34 .= '</div>'; } public static function affiliates_campaigns( $IXAP31, $IXAP32 = null ) { $IXAP24 = shortcode_atts( array( 'style' => '<style type="text/css">.branch {padding-left:1em;margin-right:1em;}</style>', 'show_from_date' => 'no', 'show_thru_date' => 'no', 'since' => __( 'since %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'until' => __( 'until %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'show_email' => 'no', 'closed' => 'yes', 'accepted' => 'yes', 'pending' => 'no', 'rejected' => 'no' ), $IXAP31 ); $IXAP24['show_from_date'] = $IXAP24['show_from_date'] === 'yes'; $IXAP24['show_thru_date'] = $IXAP24['show_thru_date'] === 'yes'; $IXAP24['accepted'] = $IXAP24['accepted'] === 'yes'; $IXAP24['closed'] = $IXAP24['closed'] === 'yes'; $IXAP24['pending'] = $IXAP24['pending'] === 'yes'; $IXAP24['rejected'] = $IXAP24['rejected'] === 'yes'; $IXAP34 = ''; if ( $user_id = get_current_user_id() ) { if ( $affiliate_ids = affiliates_get_user_affiliate( $user_id ) ) { if ( $affiliate_id = array_shift( $affiliate_ids ) ) { $IXAP25 = Affiliates_Campaign::get_campaigns( $affiliate_id ); if ( count( $IXAP25 ) > 0 ) { $IXAP34 .= '<div class="affiliates-campaigns">'; $IXAP34 .= '<table>'; $IXAP34 .= '<thead>'; $IXAP34 .= '<tr>'; $IXAP34 .= '<th>' . __( 'ID', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP34 .= '<th>' . __( 'Name', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP34 .= '<th>' . __( 'Hits', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP34 .= '<th>' . __( 'Visits', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP34 .= '<th>' . __( 'Referrals', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP34 .= '<th>' . __( 'Total', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP34 .= '</tr>'; $IXAP34 .= '</thead>'; $IXAP34 .= '<tbody>'; foreach( $IXAP25 as $IXAP10 ) { $IXAP34 .= '<tr>'; $IXAP43 = ''; $IXAP22 = $IXAP10->totals; if ( !empty( $IXAP22) ) { $IXAP44 = count( $IXAP22 ) > 1; $IXAP43 .= $IXAP44 ? '<ul>' : ''; foreach( $IXAP22 as $IXAP45 => $amount ) { $IXAP43 .= $IXAP44 ? '<li>' : ''; $IXAP43 .= sprintf( __( '%1$s %2$s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), $IXAP45, $amount ); $IXAP43 .= $IXAP44 ? '</li>' : ''; } $IXAP43 .= $IXAP44 ? '</ul>' : ''; } $IXAP34 .= sprintf( '<td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td>', $IXAP10->campaign_id, stripslashes( $IXAP10->name ), $IXAP10->hits, $IXAP10->visits, $IXAP10->referrals, $IXAP43 ); $IXAP34 .= '</tr>'; } $IXAP34 .= '</tbody>'; $IXAP34 .= '</table>'; $IXAP34 .= '</div>'; } else { $IXAP34 .= '<div class="affiliates-campaigns no-campaigns">'; $IXAP34 .= __( 'There are no campaigns.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); $IXAP34 .= '</div>'; } } } } $IXAP34 = apply_filters( 'affiliates_campaigns_output', $IXAP34 ); return $IXAP34; } public static function affiliates_manage_campaigns( $IXAP31, $IXAP32 = null ) { $IXAP34 = ''; if ( $user_id = get_current_user_id() ) { if ( $affiliate_ids = affiliates_get_user_affiliate( $user_id ) ) { if ( $affiliate_id = array_shift( $affiliate_ids ) ) { ob_start(); Affiliates_Campaign_Table::render( array( 'affiliate_id' => $affiliate_id ) ); return ob_get_clean(); } } } $IXAP34 = apply_filters( 'affiliates_manage_campaigns_output', $IXAP34 ); return $IXAP34; } public static function affiliates_pixel( $IXAP31, $IXAP32 = null ) { $IXAP31 = shortcode_atts( array( 'type' => 'image' ), $IXAP31 ); $IXAP34 = ''; if ( $user_id = get_current_user_id() ) { if ( $affiliate_ids = affiliates_get_user_affiliate( $user_id ) ) { if ( $affiliate_id = array_shift( $affiliate_ids ) ) { $IXAP5 = get_option( 'aff_pname', AFFILIATES_PNAME ); $IXAP46 = new Affiliates_Pixel( home_url(), $IXAP5 ); $IXAP47 = true; $headers = get_headers( $IXAP46->get_pixel_url() ); foreach( $headers as $IXAP48 ) { if ( stripos( $IXAP48, '200 OK' ) !== false ) { $IXAP47 = false; break; } } $IXAP46->parametric = $IXAP47; $IXAP30 = Affiliates_Url_Renderer::get_affiliate_url( $IXAP46->get_pixel_url(), $affiliate_id ); switch( $IXAP31['type'] ) { case 'img' : case 'image' : $IXAP34 .= sprintf( '&lt;img src="%s" alt="" width="1" height="1" /&gt;', esc_url( $IXAP30 ) ); break; default : $IXAP34 .= sprintf( '&lt;iframe src="%s" scrolling="no" frameborder="0" width="1" height="1"&gt;&lt;/iframe&gt;', esc_url( $IXAP30 ) ); } } } } $IXAP34 = apply_filters( 'affiliates_pixel', $IXAP34, $IXAP31 ); return $IXAP34; } } Affiliates_Enterprise_Shortcodes::init(); 