<?php
 if ( !defined( 'ABSPATH' ) ) { exit; } if ( !class_exists( 'WP_Screen' ) ) { include_once(ABSPATH . 'wp-admin/includes/class-wp-screen.php'); require_once ABSPATH . 'wp-admin/includes/screen.php'; } if ( !function_exists( 'convert_to_screen' ) ) { require_once ABSPATH . 'wp-admin/includes/template.php'; } if( !class_exists( 'WP_List_Table' ) ){ require_once ABSPATH . 'wp-admin/includes/class-wp-list-table.php'; } class Affiliates_Campaign_Table extends WP_List_Table { private $affiliate_id = null; const IXAP56 = 5000; function __construct( $args = array() ){ global $status, $IXAP57; if ( isset( $args['affiliate_id'] ) ) { $this->affiliate_id = $args['affiliate_id']; } parent::__construct( array( 'singular' => 'campaign', 'plural' => 'campaigns', 'ajax' => false, 'screen' => 'manage-campaigns' ) ); if ( !is_admin() ) { wp_enqueue_script( 'affiliates-campaigns' ); } wp_enqueue_style( 'affiliates-campaigns' ); } function column_default( $item, $IXAP58 ){ $IXAP11 = ''; switch( $IXAP58 ) { case 'affiliate_id' : if ( $affiliate = affiliates_get_affiliate( $item[$IXAP58] ) ) { $IXAP11 = stripslashes( wp_filter_nohtml_kses( $affiliate['name'] ) ); } break; case 'campaign_id' : case 'name' : case 'description' : case 'from_date' : case 'thru_date' : case 'type' : case 'status' : case 'hits' : case 'visits' : case 'referrals' : $IXAP11 = stripslashes( $item[$IXAP58] ); break; case 'totals' : $IXAP43 = ''; $IXAP22 = $item['totals']; if ( !empty( $IXAP22) ) { $IXAP44 = count( $IXAP22 ) > 1; $IXAP43 .= $IXAP44 ? '<ul>' : ''; foreach( $IXAP22 as $IXAP45 => $amount ) { $IXAP43 .= $IXAP44 ? '<li>' : ''; $IXAP43 .= sprintf( __( '%1$s %2$s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), $IXAP45, $amount ); $IXAP43 .= $IXAP44 ? '</li>' : ''; } $IXAP43 .= $IXAP44 ? '</ul>' : ''; } $IXAP11 = $IXAP43; break; case 'url' : $IXAP30 = $item['campaign']->get_url(); $IXAP11 = htmlentities( $IXAP30 ); break; case 'actions' : $IXAP59 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP59 = remove_query_arg( 'campaign_id', $IXAP59 ); $IXAP59 = remove_query_arg( 'action', $IXAP59 ); printf( "<a class='button action' title='%s' href='%s'>%s</a>", esc_attr( __( 'Edit this campaign', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ), esc_url( wp_nonce_url( add_query_arg( array( 'campaign_id' => $item['campaign_id'], 'action' => 'edit-campaign' ), $IXAP59 ) ) ), __( 'Edit', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); break; default : if ( is_string( $item[$IXAP58] ) ) { $IXAP11 = wp_strip_all_tags( $item[$IXAP58] ); } } return $IXAP11; } function column_cb( $item ){ $IXAP60 = ''; $IXAP61 = new Affiliates_Campaign(); if ( $IXAP61->read( $item['campaign_id'] ) ) { if ( $IXAP61->hits || $IXAP61->referrals ) { $IXAP60 = ' disabled="disabled" '; } } return sprintf( '<input class="campaign-cb" type="checkbox" name="_campaign_id[]" value="%d" %s />', intval( $item['campaign_id'] ), $IXAP60 ); } function get_columns(){ $IXAP62 = array( 'cb' => '<input type="checkbox" />', 'campaign_id' => __( 'ID', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'affiliate_id' => __( 'Affiliate', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'name' => __( 'Name', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'description' => __( 'Description', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'hits' => __( 'Hits', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'visits' => __( 'Visits', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'referrals' => __( 'Referrals', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'totals' => __( 'Totals', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'url' => __( 'URL', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'actions' => '' ); if ( isset( $this->affiliate_id ) ) { unset( $IXAP62['affiliate_id'] ); } return $IXAP62; } function get_sortable_columns() { $sortable_columns = array( 'campaign_id' => array( 'campaign_id', false ), 'affiliate_id' => array( 'affiliate_id', false ), 'name' => array( 'name', false ), 'description' => array( 'description', false ) ); if ( isset( $this->affiliate_id ) ) { unset( $sortable_columns['affiliate_id'] ); } return $sortable_columns; } function get_bulk_actions() { $actions = array( 'delete' => __( 'Delete', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); return $actions; } function process_bulk_action() { $action = $this->current_action(); switch( $action ) { case 'delete' : if ( !empty( $_REQUEST['_campaign_id'] ) ) { $IXAP63 = $_REQUEST['_campaign_id']; $affiliate_id = Affiliates_Affiliate_WordPress::get_user_affiliate_id(); if ( is_array( $IXAP63 ) ) { foreach( $IXAP63 as $IXAP12 ) { if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) || Affiliates_Campaign::is_affiliate_campaign( $affiliate_id, $IXAP12 ) ) { $IXAP61 = new Affiliates_Campaign(); if ( $IXAP61->read( $IXAP12 ) ) { if ( $IXAP61->hits || $IXAP61->referrals ) { } else { $IXAP61->delete(); } } } } } } break; } } function prepare_items() { global $wpdb; $IXAP64 = 10; $IXAP62 = $this->get_columns(); $IXAP65 = array(); $sortable = $this->get_sortable_columns(); $this->_column_headers = array ($IXAP62, $IXAP65, $sortable ); $this->process_bulk_action(); $IXAP25 = Affiliates_Campaign::get_campaigns( $this->affiliate_id ); $data = array(); $i = 0; foreach( $IXAP25 as $IXAP10 ) { $data[] = $IXAP10->to_array(); $data[$i]['campaign'] = $IXAP10; $i++; } if ( !empty( $data ) ) { usort( $data, array( __CLASS__, 'sort' ) ); } $IXAP66 = $this->get_pagenum(); $IXAP67 = count( $data ); $data = array_slice( $data, ( ( $IXAP66 - 1 ) * $IXAP64 ), $IXAP64 ); $this->items = $data; $this->set_pagination_args( array( 'total_items' => $IXAP67, 'per_page' => $IXAP64, 'total_pages' => ceil( $IXAP67 / $IXAP64 ) ) ); } public static function sort( $item1, $item2 ) { $IXAP68 = !empty( $_REQUEST['orderby'] ) ? $_REQUEST['orderby'] : 'campaign_id'; $IXAP69 = strtolower( !empty($_REQUEST['order'] ) ? $_REQUEST['order'] : 'asc' ); $IXAP11 = 0; if ( $IXAP68 == 'campaign_id' ) { $IXAP11 = $item1[$IXAP68] - $item2[$IXAP68]; } else if ( $IXAP68 == 'affiliate_id' ) { $IXAP70 = affiliates_get_affiliate($item1[$IXAP68]); $IXAP71 = affiliates_get_affiliate($item2[$IXAP68]); $IXAP11 = strcmp( $IXAP70['name'], $IXAP71['name'] ); } else { $IXAP11 = strcmp( isset( $item1[$IXAP68] ) ? $item1[$IXAP68] : '', isset( $item2[$IXAP68] ) ? $item2[$IXAP68] : '' ); } return ( $IXAP69 === 'asc') ? $IXAP11 : -$IXAP11; } public static function render( $IXAP24 = array() ) { global $wpdb; $action_executed = false; if ( isset( $_REQUEST['campaign-action'] ) || isset( $_REQUEST['campaign-action'] ) ) { if ( wp_verify_nonce($_REQUEST['_wpnonce'] ) ) { if ( isset( $_REQUEST['action'] ) ) { switch( $_REQUEST['action'] ) { case 'create-campaign' : $affiliate_id = !empty( $_REQUEST['affiliate_id'] ) ? intval( $_REQUEST['affiliate_id'] ) : null; if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) || ( ( $affiliate_id !== null ) && ( $affiliate_id == Affiliates_Affiliate_WordPress::get_user_affiliate_id() ) ) ) { $name = !empty( $_REQUEST['campaign_name'] ) ? wp_strip_all_tags( trim( $_REQUEST['campaign_name'] ) ) : ''; $IXAP72 = !empty( $_REQUEST['campaign_description'] ) ? substr( wp_strip_all_tags( trim( $_REQUEST['campaign_description'] ) ), 0, self::IXAP56 ) : ''; $IXAP61 = new Affiliates_Campaign( (object) array( 'affiliate_id' => $affiliate_id, 'name' => $name, 'description' => $IXAP72 ) ); if ( $IXAP61->create() ) { $action_executed = true; echo '<div class="updated">'; echo __( 'Campaign created.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</div>'; } else { echo '<div class="error">'; echo __( 'Campaign could not be created.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</div>'; } } else { wp_die( __( 'Access denied.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); } break; case 'edit-campaign' : $affiliate_id = !empty( $_REQUEST['affiliate_id'] ) ? intval( $_REQUEST['affiliate_id'] ) : null; $IXAP12 = !empty( $_REQUEST['campaign_id'] ) ? intval( $_REQUEST['campaign_id'] ) : null; if ( !empty( $IXAP12 ) ) { $IXAP61 = new Affiliates_Campaign(); if ( $IXAP61->read( $IXAP12 ) ) { if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) || ( ( $affiliate_id !== null ) && ( $affiliate_id == Affiliates_Affiliate_WordPress::get_user_affiliate_id() ) && Affiliates_Campaign::is_affiliate_campaign( $affiliate_id, $IXAP12 ) ) ) { $name = !empty( $_REQUEST['campaign_name'] ) ? wp_strip_all_tags( trim( $_REQUEST['campaign_name'] ) ) : ''; $IXAP72 = !empty( $_REQUEST['campaign_description'] ) ? substr( wp_strip_all_tags( trim( $_REQUEST['campaign_description'] ) ), 0, self::IXAP56 ) : ''; $IXAP61->name = $name; $IXAP61->description = $IXAP72; if ( $IXAP61->update() ) { $action_executed = true; echo '<div class="updated">'; echo __( 'Campaign updated.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</div>'; } else { if ( ( $wpdb->rows_affected === 0 ) && ( $wpdb->last_error === "" ) ) { $action_executed = true; } else { echo '<div class="error">'; echo __( 'Campaign could not be updated.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</div>'; } } } else { wp_die( __( 'Access denied.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); } } } break; } } } } $affiliate_id = isset( $IXAP24['affiliate_id'] ) ? intval( $IXAP24['affiliate_id'] ) : null; $is_create = false; $is_edit = false; if ( !$action_executed ) { if ( isset( $_REQUEST['action'] ) && isset( $_REQUEST['_wpnonce'] ) && wp_verify_nonce( $_REQUEST['_wpnonce'] ) ) { $IXAP12 = isset( $_REQUEST['campaign_id'] ) ? intval( $_REQUEST['campaign_id'] ) : null; switch( $_REQUEST['action'] ) { case 'create-campaign' : $is_create = true; self::create_campaign_form( $affiliate_id ); break; case 'edit-campaign' : $is_edit = true; self::edit_campaign_form( $affiliate_id, $IXAP12 ); break; } } } if ( !$is_create && !$is_edit ) { $IXAP73 = new Affiliates_Campaign_Table( $IXAP24 ); $IXAP73->prepare_items(); echo '<div class="campaigns">'; echo '<form class="campaigns-table" method="get">'; echo '<div>'; echo '<div class="buttons">'; $IXAP59 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP59 = remove_query_arg( 'affiliate_id', $IXAP59 ); $IXAP59 = remove_query_arg( 'action', $IXAP59 ); printf( "<a class='button action' title='%s' href='%s'>%s</a>", esc_attr( __( 'Create a new campaign', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ), esc_url( wp_nonce_url( add_query_arg( array( 'affiliate_id' => $affiliate_id, 'action' => 'create-campaign' ), $IXAP59 ) ) ), __( 'Create a Campaign', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); echo '</div>'; echo '<br/>'; if ( isset( $_REQUEST['page'] ) ) { echo sprintf( '<input type="hidden" name="page" value="%s" />', esc_attr( $_REQUEST['page'] ) ); } $IXAP73->display(); echo '</div>'; echo '</form>'; echo '</div>'; } } public static function create_campaign_form( $affiliate_id = null ) { wp_enqueue_style( 'affiliates-campaigns' ); if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) || ( $affiliate_id !== null ) && ( $affiliate_id == Affiliates_Affiliate_WordPress::get_user_affiliate_id() ) ) { $name = isset( $_REQUEST['campaign_name'] ) ? stripslashes( wp_strip_all_tags( trim( $_REQUEST['campaign_name'] ) ) ) : ''; $IXAP72 = isset( $_REQUEST['campaign_description'] ) ? stripslashes( substr( wp_strip_all_tags( trim( $_REQUEST['campaign_description'] ) ), 0, self::IXAP56 ) ) : ''; echo '<div class="campaign-create">'; echo '<h2>'; echo __( 'Create Campaign', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</h2>'; printf( '<form action="%s" method="post">', esc_attr( self::current_url_clean() ) ); echo '<div>'; if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { if ( isset( $_REQUEST['affiliate_id'] ) ) { $affiliate_id = intval( $_REQUEST['affiliate_id'] ); } echo '<div class="field affiliate_id">'; echo Affiliates_UI_Elements::affiliates_select( array( 'affiliate_id' => $affiliate_id ) ); echo '</div>'; } else { printf( '<input type="hidden" name="affiliate_id" value="%d" />', intval( $affiliate_id ) ); } echo '<div class="field name">'; echo '<label>'; echo __( 'Name', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '<br/>'; printf( '<input type="text" name="campaign_name" value="%s" />', esc_attr( $name ) ); echo '</label>'; echo '</div>'; echo '<div class="field description">'; echo '<label>'; echo __( 'Description', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '<br/>'; echo '<textarea name="campaign_description">'; echo htmlentities( $IXAP72 ); echo '</textarea>'; echo '</label>'; echo '</div>'; echo '<div class="buttons">'; printf( '<input type="submit" name="campaign-action" class="button button-primary action" value="%s" />', __( 'Create', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); echo '<input type="hidden" name="action" value="create-campaign" />'; echo ' '; self::cancel_link(); wp_nonce_field(); wp_referer_field(); echo '</div>'; echo '</div>'; echo '</form>'; echo '</div>'; } else { wp_die( __( 'Access denied.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); } } public static function edit_campaign_form( $affiliate_id, $IXAP12 ) { wp_enqueue_style( 'affiliates-campaigns' ); if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) || ( $affiliate_id !== null ) && ( $affiliate_id == Affiliates_Affiliate_WordPress::get_user_affiliate_id() ) && Affiliates_Campaign::is_affiliate_campaign( $affiliate_id, $IXAP12 ) ) { $IXAP10 = new Affiliates_Campaign(); if ( $IXAP10->read( $IXAP12 ) ) { echo '<div class="campaign-edit">'; echo '<h2>'; echo __( 'Edit Campaign', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</h2>'; printf( '<form action="%s" method="post">', esc_attr( self::current_url_clean() ) ); echo '<div>'; if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { if ( $affiliate = Affiliates_Affiliate::get_affiliate( $affiliate_id ) ) { echo '<div class="field name">'; echo '<label>'; echo __( 'Affiliate', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo ' '; printf( '<input type="text" name="affiliate-name" value="%s" readonly="readonly" />', esc_attr( $affiliate->name ) ); echo '</label>'; echo '</div>'; } } echo '<div class="field name">'; echo '<label>'; echo __( 'Name', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '<br/>'; printf( '<input type="text" name="campaign_name" value="%s" />', esc_attr( stripslashes( $IXAP10->name ) ) ); echo '</label>'; echo '</div>'; echo '<div class="field description">'; echo '<label>'; echo __( 'Description', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '<br/>'; echo '<textarea name="campaign_description">'; echo htmlentities( stripslashes( $IXAP10->description ) ); echo '</textarea>'; echo '</label>'; echo '</div>'; echo '<div class="buttons">'; printf( '<input type="hidden" name="affiliate_id" value="%d" />', intval( $affiliate_id ) ); printf( '<input type="hidden" name="campaign_id" value="%d" />', intval( $IXAP12 ) ); printf( '<input type="submit" name="campaign-action" class="button button-primary action" value="%s" />', __( 'Save', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); echo '<input type="hidden" name="action" value="edit-campaign" />'; echo ' '; self::cancel_link(); wp_nonce_field(); echo '</div>'; echo '</div>'; echo '</form>'; echo '</div>'; } } } private static function cancel_link() { $IXAP59 = self::current_url_clean(); printf( '<a class="button action" title="%s" href="%s">%s</a>', esc_attr( __( 'Cancel this action', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ), esc_url( $IXAP59 ), __( 'Cancel', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); } private static function current_url_clean() { $IXAP59 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP59 = remove_query_arg( 'affiliate_id', $IXAP59 ); $IXAP59 = remove_query_arg( 'campaign_id', $IXAP59 ); $IXAP59 = remove_query_arg( 'action', $IXAP59 ); $IXAP59 = remove_query_arg( '_wpnonce', $IXAP59 ); return $IXAP59; } public static function admin_enqueue_scripts() { wp_register_style( 'affiliates-campaigns', AFFILIATES_ENTERPRISE_PLUGIN_URL . 'css/affiliates-campaigns.css', array(), AFFILIATES_EEXT_VERSION ); } public static function wp_enqueue_scripts() { wp_register_script( 'affiliates-campaigns', AFFILIATES_ENTERPRISE_PLUGIN_URL . 'js/affiliates-campaigns.js', array( 'jquery' ), AFFILIATES_EEXT_VERSION, true ); wp_register_style( 'affiliates-campaigns', AFFILIATES_ENTERPRISE_PLUGIN_URL . 'css/affiliates-campaigns.css', array(), AFFILIATES_EEXT_VERSION ); } public static function init() { add_action( 'wp_enqueue_scripts', array( __CLASS__, 'wp_enqueue_scripts' ) ); add_action( 'admin_enqueue_scripts', array( __CLASS__, 'admin_enqueue_scripts' ) ); } } Affiliates_Campaign_Table::init(); 