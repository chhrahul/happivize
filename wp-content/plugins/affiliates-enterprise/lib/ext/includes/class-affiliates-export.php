<?php
 class Affiliates_Export { private $charset = 'UTF-8'; public function __construct() { $this->charset = get_option( 'blog_charset' ); } public function __set( $name, $value ) { switch( $name ) { case 'charset' : $this->charset = $value; break; } } public function __get( $name ) { $IXAP11 = null; switch( $name ) { case 'charset' : $IXAP11 = $this->charset; break; } return $IXAP11; } public function request() { $now = date( 'Y-m-d-H-i-s', time() ); header( 'Content-Description: File Transfer' ); if ( !empty( $this->charset ) ) { header( 'Content-Type: text/tab-separated-values; charset=' . $this->charset ); } else { header( 'Content-Type: text/tab-separated-values' ); } header( "Content-Disposition: attachment; filename=\"affiliates-export-$now.tsv\"" ); $this->entries(); echo "\n"; } private function entries() { global $wpdb, $affiliates_db, $affiliates_options; $affiliates_table = $affiliates_db->get_tablename( 'affiliates' ); $affiliates_users_table = $affiliates_db->get_tablename( 'affiliates_users' ); $affiliates_attributes_table = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP83 = date( 'Y-m-d', time() ); $IXAP105 = array( 'affiliate_id' => __( 'Id', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'name' => __( 'Affiliate', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'email' => __( 'Email', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'user_login' => __( 'Username', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'from_date' => __( 'From', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'thru_date' => __( 'Until', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'links' => __( 'Links', AFFILIATES_PRO_PLUGIN_DOMAIN ), ); $IXAP105 = $IXAP105 + Affiliates_Attributes::get_keys(); $IXAP199 = array(); foreach( array_keys( $IXAP105 ) as $key ) { $key = preg_replace( '/(\.|\-)/', '_', $key ); switch( $key ) { case 'name' : case 'email' : case 'user_login' : $IXAP199[$key] = true; break; default : $IXAP199[$key] = false; } } $affiliates_overview_columns = $IXAP199; foreach( $affiliates_options->get_option( 'affiliates_overview_columns', array() ) as $key => $value ) { $affiliates_overview_columns[$key] = $value; } $IXAP200 = array(); foreach( $IXAP105 as $key => $IXAP161 ) { $normalized_key = preg_replace( '/(\.|\-)/', '_', $key ); if ( isset( $affiliates_overview_columns[$normalized_key] ) && $affiliates_overview_columns[$normalized_key] ) { $IXAP200[] = $IXAP161; } } require_once AFFILIATES_CORE_LIB . '/class-affiliates-settings.php'; require_once AFFILIATES_CORE_LIB . '/class-affiliates-settings-registration.php'; $registration_fields = Affiliates_Settings_Registration::get_fields(); foreach( Affiliates_Registration::get_skip_meta_fields() as $key ) { unset( $registration_fields[$key] ); } if ( !empty( $registration_fields ) ) { foreach( $registration_fields as $name => $field ) { if ( isset( $affiliates_overview_columns[$name] ) && $affiliates_overview_columns[$name] && $field['enabled'] ) { $IXAP200[] = stripslashes( $field['label'] ); } } } $n = count( $IXAP200 ); for ( $i = 0; $i < $n; $i++ ) { echo $IXAP200[$i]; if ( $i < $n - 1 ) { echo "\t"; } } echo "\n"; $IXAP15 = $affiliates_options->get_option( 'affiliates_from_date', null ); $IXAP20 = null; $IXAP16 = $affiliates_options->get_option( 'affiliates_thru_date', null ); $IXAP21 = null; $affiliate_id = $affiliates_options->get_option( 'affiliates_affiliate_id', null ); $affiliate_name = $affiliates_options->get_option( 'affiliates_affiliate_name', null ); $affiliate_email = $affiliates_options->get_option( 'affiliates_affiliate_email', null ); $affiliate_user_login = $affiliates_options->get_option( 'affiliates_affiliate_user_login', null ); $show_deleted = $affiliates_options->get_option( 'affiliates_show_deleted', false ); $show_inoperative = $affiliates_options->get_option( 'affiliates_show_inoperative', false ); $show_totals = $affiliates_options->get_option( 'affiliates_show_totals', true ); $IXAP179 = array( " 1=%d " ); $IXAP180 = array( 1 ); if ( $affiliate_id ) { $IXAP179[] = " $affiliates_table.affiliate_id = %d "; $IXAP180[] = $affiliate_id; } if ( $affiliate_name ) { $IXAP179[] = " $affiliates_table.name LIKE '%%%s%%' "; $IXAP180[] = $affiliate_name; } if ( $affiliate_email ) { $IXAP179[] = " $affiliates_table.email LIKE '%%%s%%' "; $IXAP180[] = $affiliate_email; } if ( $affiliate_user_login ) { $IXAP179[] = " $wpdb->users.user_login LIKE '%%%s%%' "; $IXAP180[] = $affiliate_user_login; } if ( !$show_deleted ) { $IXAP179[] = " $affiliates_table.status = %s "; $IXAP180[] = 'active'; } if ( !$show_inoperative ) { $IXAP179[] = " $affiliates_table.from_date <= %s AND ( $affiliates_table.thru_date IS NULL OR $affiliates_table.thru_date >= %s ) "; $IXAP180[] = $IXAP83; $IXAP180[] = $IXAP83; } if ( $IXAP20 && $IXAP21 ) { $IXAP179[] = " $affiliates_table.from_date >= %s AND ( $affiliates_table.thru_date IS NULL OR $affiliates_table.thru_date < %s ) "; $IXAP180[] = $IXAP20; $IXAP180[] = $IXAP21; } else if ( $IXAP20 ) { $IXAP179[] = " $affiliates_table.from_date >= %s "; $IXAP180[] = $IXAP20; } else if ( $IXAP21 ) { $IXAP179[] = " $affiliates_table.thru_date < %s "; $IXAP180[] = $IXAP21; } if ( !empty( $IXAP179 ) ) { $IXAP179 = " WHERE " . implode( " AND ", $IXAP179 ); } else { $IXAP179 = ''; } $IXAP3 = $wpdb->prepare( "SELECT $affiliates_table.*, $wpdb->users.* " . "FROM $affiliates_table " . "LEFT JOIN $affiliates_users_table ON $affiliates_table.affiliate_id = $affiliates_users_table.affiliate_id " . "LEFT JOIN $wpdb->users on $affiliates_users_table.user_id = $wpdb->users.ID " . "LEFT JOIN $affiliates_attributes_table ON $affiliates_table.affiliate_id = $affiliates_attributes_table.affiliate_id " . "$IXAP179 " , $IXAP180 ); $IXAP26 = $wpdb->get_results( $IXAP3, OBJECT ); foreach( $IXAP26 as $IXAP11 ) { $values = array(); if ( isset( $affiliates_overview_columns['affiliate_id'] ) && $affiliates_overview_columns['affiliate_id'] ) { $values[] = $IXAP11->affiliate_id; } if ( isset( $affiliates_overview_columns['name'] ) && $affiliates_overview_columns['name'] ) { $values[] = stripslashes( wp_filter_nohtml_kses( $IXAP11->name ) ); } if ( isset( $affiliates_overview_columns['email'] ) && $affiliates_overview_columns['email'] ) { $values[] = $IXAP11->email; } if ( isset( $affiliates_overview_columns['user_login'] ) && $affiliates_overview_columns['user_login'] ) { $values[] = $IXAP11->user_login; } if ( isset( $affiliates_overview_columns['from_date'] ) && $affiliates_overview_columns['from_date'] ) { $values[] = $IXAP11->from_date; } if ( isset( $affiliates_overview_columns['thru_date'] ) && $affiliates_overview_columns['thru_date'] ) { $values[] = $IXAP11->thru_date; } if ( isset( $affiliates_overview_columns['links'] ) && $affiliates_overview_columns['links'] ) { $values[] = Affiliates_Url_Renderer::get_affiliate_url( get_bloginfo( 'url' ), $IXAP11->affiliate_id ); } foreach( Affiliates_Attributes::get_keys() as $IXAP201 => $IXAP202 ) { $IXAP203 = $IXAP201; $IXAP201 = preg_replace( '/(\.|\-)/', '_', $IXAP201 ); if ( isset( $affiliates_overview_columns[$IXAP201] ) && $affiliates_overview_columns[$IXAP201] ) { $IXAP204 = $affiliates_db->get_value( "SELECT attr_value FROM $affiliates_attributes_table WHERE affiliate_id = %d AND attr_key = %s", $IXAP11->affiliate_id, $IXAP203 ); $values[] = wp_filter_nohtml_kses( $IXAP204 ); } } if ( !empty( $registration_fields ) ) { foreach( $registration_fields as $name => $field ) { if ( isset( $affiliates_overview_columns[$name] ) && $affiliates_overview_columns[$name] && $field['enabled'] ) { $type = isset( $field['type'] ) ? $field['type'] : 'text'; $value = ''; switch( $name ) { case 'user_login' : $value = $user->user_login; break; case 'user_email' : $value = $user->user_email; break; case 'user_url' : $value = $user->user_url; break; case 'password' : $value = ''; break; default : $value = get_user_meta( $IXAP11->ID, $name , true ); } $values[] = stripslashes( $value ); } } } $n = count( $values ); for ( $i = 0; $i < $n; $i++ ) { echo $values[$i]; echo "\t"; } echo "\n"; } } public static function init() { add_action( 'init', array(__CLASS__,'wp_init' ) ); } public static function wp_init() { if ( isset( $_REQUEST['action'] ) && $_REQUEST['action'] == 'export' && wp_verify_nonce( $_REQUEST['export-nonce'], 'export-affiliates' ) ) { if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP205 = new Affiliates_Export(); $IXAP205->request(); die; } } } Affiliates_Export::init(); 