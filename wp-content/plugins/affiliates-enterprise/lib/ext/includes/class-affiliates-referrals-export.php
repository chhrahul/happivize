<?php
 class Affiliates_Referrals_Export { private $charset = 'UTF-8'; public function __construct() { $this->charset = get_option( 'blog_charset' ); } public function __set( $name, $value ) { switch( $name ) { case 'charset' : $this->charset = $value; break; } } public function __get( $name ) { $IXAP11 = null; switch( $name ) { case 'charset' : $IXAP11 = $this->charset; break; } return $IXAP11; } public function request() { $now = date( 'Y-m-d-H-i-s', time() ); header( 'Content-Description: File Transfer' ); if ( !empty( $this->charset ) ) { header( 'Content-Type: text/tab-separated-values; charset=' . $this->charset ); } else { header( 'Content-Type: text/tab-separated-values' ); } header( "Content-Disposition: attachment; filename=\"affiliates-export-$now.tsv\"" ); $this->entries(); echo "\n"; } private function entries() { global $wpdb, $affiliates_db, $affiliates_options; $affiliates_table = $affiliates_db->get_tablename( 'affiliates' ); $affiliates_users_table = $affiliates_db->get_tablename( 'affiliates_users' ); $affiliates_attributes_table = $affiliates_db->get_tablename( 'affiliates_attributes' ); $referrals_table = $affiliates_db->get_tablename( 'referrals' ); $IXAP18 = $affiliates_db->get_tablename( 'hits' ); $posts_table = $wpdb->prefix . 'posts'; $IXAP83 = date( 'Y-m-d', time() ); $IXAP105 = array( 'referral_id' => __( 'Referral ID', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'reference' => __( 'Reference', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'amount' => __( 'Amount', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'currency_id' => __( 'Currency', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'status' => __( 'Status', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'type' => __( 'Type', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'datetime' => __( 'Date', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'description' => __( 'Description', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'post_id' => __( 'Post ID', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'post_title' => __( 'Post', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'ip' => __( 'IP', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'affiliate_id' => __( 'Affiliate ID', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'name' => __( 'Affiliate', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'user_id' => __( 'User ID', AFFILIATES_PRO_PLUGIN_DOMAIN ), ); if ( AFFILIATES_PLUGIN_NAME == 'affiliates-enterprise' ) { $IXAP105['campaign_id'] = __( 'Campaign ID', AFFILIATES_PRO_PLUGIN_DOMAIN ); } $IXAP105['data'] = __( 'Data', AFFILIATES_PRO_PLUGIN_DOMAIN ); $n = count( $IXAP105 ); $i = 0; foreach( $IXAP105 as $key => $IXAP161 ) { echo $IXAP161; $i++; if ( $i < $n ) { echo "\t"; } } echo "\n"; $IXAP15 = $affiliates_options->get_option( 'referrals_from_date', null ); $IXAP16 = $affiliates_options->get_option( 'referrals_thru_date', null ); $affiliate_id = $affiliates_options->get_option( 'referrals_affiliate_id', null ); $status = $affiliates_options->get_option( 'referrals_status', null ); $search = $affiliates_options->get_option( 'referrals_search', null ); $search_description = $affiliates_options->get_option( 'referrals_search_description', null ); $IXAP207 = $affiliates_options->get_option( 'referrals_expanded', null ); $IXAP208 = $affiliates_options->get_option( 'referrals_expanded_description', null ); $IXAP209 = $affiliates_options->get_option( 'referrals_expanded_data', null ); $show_inoperative = $affiliates_options->get_option( 'referrals_show_inoperative', null ); $IXAP179 = " WHERE 1=%d "; $IXAP180 = array( 1 ); if ( $IXAP15 ) { $IXAP20 = DateHelper::u2s( $IXAP15 ); } if ( $IXAP16 ) { $IXAP21 = DateHelper::u2s( $IXAP16, 24*3600 ); } if ( $IXAP15 && $IXAP16 ) { $IXAP179 .= " AND datetime >= %s AND datetime < %s "; $IXAP180[] = $IXAP20; $IXAP180[] = $IXAP21; } else if ( $IXAP15 ) { $IXAP179 .= " AND datetime >= %s "; $IXAP180[] = $IXAP20; } else if ( $IXAP16 ) { $IXAP179 .= " AND datetime < %s "; $IXAP180[] = $IXAP21; } if ( $affiliate_id ) { $IXAP179 .= " AND r.affiliate_id = %d "; $IXAP180[] = $affiliate_id; } if ( $status ) { $IXAP179 .= " AND r.status = %s "; $IXAP180[] = $status; } if ( $search ) { if ( $search_description ) { $IXAP179 .= " AND ( r.data LIKE '%%%s%%' OR r.description LIKE '%%%s%%' ) "; $IXAP180[] = $search; $IXAP180[] = $search; } else { $IXAP179 .= " AND r.data LIKE '%%%s%%' "; $IXAP180[] = $search; } } $IXAP3 = $wpdb->prepare("
			SELECT r.*, a.affiliate_id, a.name
			FROM $referrals_table r
			LEFT JOIN $affiliates_table a ON r.affiliate_id = a.affiliate_id
			LEFT JOIN $posts_table p ON r.post_id = p.ID
			$IXAP179
			", $IXAP180 + $IXAP180 ); $IXAP26 = $wpdb->get_results( $IXAP3, OBJECT ); foreach( $IXAP26 as $IXAP11 ) { $values = array(); $values[] = $IXAP11->referral_id; $values[] = $IXAP11->reference; $values[] = $IXAP11->amount; $values[] = $IXAP11->currency_id; $values[] = $IXAP11->status; $values[] = $IXAP11->type; $values[] = $IXAP11->datetime; $values[] = stripslashes( $IXAP11->description ); $values[] = $IXAP11->post_id; $values[] = stripslashes( get_the_title( $IXAP11->post_id ) ); $values[] = $IXAP11->ip; $values[] = $IXAP11->affiliate_id; $values[] = stripslashes( $IXAP11->name ); $values[] = $IXAP11->user_id; if ( AFFILIATES_PLUGIN_NAME == 'affiliates-enterprise' ) { $values[] = $IXAP11->campaign_id; } $data = $IXAP11->data; if ( empty( $data ) ) { $values[] = ''; } else { $data = unserialize( $data ); if ( $data ) { if ( is_array( $data ) ) { foreach ( $data as $key => $info ) { $IXAP190 = __( $info['title'], $info['domain'] ); $IXAP190 = stripslashes( wp_filter_nohtml_kses( $IXAP190 ) ); $values[] = $IXAP190 . ' : ' . stripslashes( $info['value'] ); } } else if ( is_string( $data ) ) { $values[] = stripslashes( $data ); } else { $values[] = stripslahes( var_export( $data, true ) ); } } } $n = count( $values ); for ( $i = 0; $i < $n; $i++ ) { echo $values[$i]; echo "\t"; } echo "\n"; } } public static function init() { add_action( 'init', array(__CLASS__,'wp_init' ) ); add_filter( 'affiliates_admin_referrals_secondary_actions', array( __CLASS__, 'affiliates_admin_referrals_secondary_actions' ) ); } public static function affiliates_admin_referrals_secondary_actions( $IXAP34 ) { $IXAP34 .= '<div style="display:inline">'; $IXAP34 .= '<form style="display:inline" id="export-referrals" action="" method="post">'; $IXAP34 .= sprintf( '<input class="button" type="submit" value="%s" />', __( 'Export', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); $IXAP34 .= '<input type="hidden" name="action" value="export-referrals" />'; $IXAP34 .= wp_nonce_field( 'export-referrals', 'export-nonce', true, false ); $IXAP34 .= '</form>'; $IXAP34 .= '</div>'; return $IXAP34; } public static function wp_init() { if ( isset( $_REQUEST['action'] ) && $_REQUEST['action'] == 'export-referrals' && wp_verify_nonce( $_REQUEST['export-nonce'], 'export-referrals' ) ) { if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP205 = new Affiliates_Referrals_Export(); $IXAP205->request(); die; } } } Affiliates_Referrals_Export::init(); 