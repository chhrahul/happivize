<?php
 class Affiliates_Affiliate_Stats_Widget extends WP_Widget { function __construct() { parent::__construct( false, $name = 'Affiliates Affiliate Stats' ); } function widget( $args, $instance ) { if ( !affiliates_user_is_affiliate() ) { return; } extract( $args ); $IXAP190 = isset( $instance['title'] ) ? apply_filters( 'widget_title', $instance['title'] ) : ''; $IXAP256 = $args['widget_id']; echo $before_widget; if ( !empty( $IXAP190 ) ) { echo $before_title . $IXAP190 . $after_title; } $IXAP257 = '-' . $IXAP256; $IXAP24 = array( 'is_widget' => true ); $IXAP24 = array_merge( $IXAP24, $instance ); echo $this->render_affiliate_stats( $IXAP24, $IXAP256 ); echo $after_widget; } function update( $new_instance, $IXAP258 ) { $settings = $IXAP258; if ( !empty( $new_instance['title'] ) ) { $settings['title'] = strip_tags( $new_instance['title'] ); } else { unset( $settings['title'] ); } $IXAP22 = array( 'show_totals_accepted', 'show_totals_pending', 'show_totals_closed', 'show_totals_rejected' ); foreach ( $IXAP22 as $IXAP23 ) { if ( !empty( $new_instance[$IXAP23] ) ) { $settings[$IXAP23] = true; } else { unset( $settings[$IXAP23] ); } } return $settings; } function form( $instance ) { $IXAP190 = isset( $instance['title'] ) ? esc_attr( $instance['title'] ) : ''; ?>
		<p>
			<label for="<?php echo $this->get_field_id('title'); ?>"><?php _e( 'Title:', AFFILIATES_PRO_PLUGIN_DOMAIN ); ?></label> 
			<input class="widefat" id="<?php echo $this->get_field_id( 'title' ); ?>" name="<?php echo $this->get_field_name( 'title' ); ?>" type="text" value="<?php echo $IXAP190; ?>" />
		</p>
		<?php
 $show_totals_accepted = isset( $instance['show_totals_accepted'] ) ? $instance['show_totals_accepted'] : false; echo '<input type="checkbox" ' . ( $show_totals_accepted ? ' checked="checked" ' : '' ) . ' name="' . $this->get_field_name( 'show_totals_accepted' ) . '" id="' . $this->get_field_id( 'show_totals_accepted' ) . '"/>'; echo '<label for="' . $this->get_field_name( 'show_totals_accepted' ) . '">' . __( 'Show totals for accepted referrals', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>'; echo '<br/>'; $show_totals_pending = isset( $instance['show_totals_pending'] ) ? $instance['show_totals_pending'] : false; echo '<input type="checkbox" ' . ( $show_totals_pending ? ' checked="checked" ' : '' ) . ' name="' . $this->get_field_name( 'show_totals_pending' ) . '" id="' . $this->get_field_id( 'show_totals_pending' ) . '"/>'; echo '<label for="' . $this->get_field_name( 'show_totals_pending' ) . '">' . __( 'Show totals for pending referrals', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>'; echo '<br/>'; $show_totals_closed = isset( $instance['show_totals_closed'] ) ? $instance['show_totals_closed'] : false; echo '<input type="checkbox" ' . ( $show_totals_closed ? ' checked="checked" ' : '' ) . ' name="' . $this->get_field_name( 'show_totals_closed' ) . '" id="' . $this->get_field_id( 'show_totals_closed' ) . '"/>'; echo '<label for="' . $this->get_field_name( 'show_totals_closed' ) . '">' . __( 'Show totals for closed referrals', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>'; echo '<br/>'; $show_totals_rejected = isset( $instance['show_totals_rejected'] ) ? $instance['show_totals_rejected'] : false; echo '<input type="checkbox" ' . ( $show_totals_rejected ? ' checked="checked" ' : '' ) . ' name="' . $this->get_field_name( 'show_totals_rejected' ) . '" id="' . $this->get_field_id( 'show_totals_rejected' ) . '"/>'; echo '<label for="' . $this->get_field_name( 'show_totals_rejected' ) . '">' . __( 'Show totals for rejected referrals', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>'; } public static function render_affiliate_stats( $IXAP24 = array() ) { global $affiliates_db; $IXAP34 = ''; $affiliate_id = Affiliates_Affiliate_WordPress::get_user_affiliate_id(); if ( $affiliate_id === false ) { return $IXAP34; } wp_enqueue_style( 'affiliates' ); wp_enqueue_style( 'affiliates-pro' ); $affiliates_table = $affiliates_db->get_tablename( 'affiliates' ); $referrals_table = $affiliates_db->get_tablename( 'referrals' ); $IXAP18 = $affiliates_db->get_tablename( 'hits' ); $IXAP145 = affiliates_get_affiliate_visits( $affiliate_id ); $IXAP142 = affiliates_get_affiliate_hits( $affiliate_id ); $referrals = affiliates_get_affiliate_referrals( $affiliate_id ); if ( $IXAP145 > 0 ) { $IXAP259 = round( $referrals / $IXAP145, I_Affiliates_Stats_Renderer::IXAP225 ); } else { $IXAP259 = 0; } $IXAP34 .= '<div class="visits">' . sprintf( _n( '%d Visit', '%d Visits', $IXAP145, AFFILIATES_PRO_PLUGIN_DOMAIN ), $IXAP145 ) . '</div>'; $IXAP34 .= '<div class="hits">' . sprintf( _n( '%d Hit', '%d Hits', $IXAP142, AFFILIATES_PRO_PLUGIN_DOMAIN ), $IXAP142 ) . '</div>'; $IXAP34 .= '<div class="referrals">' . sprintf( _n( '%d Referral', '%d Referrals', $referrals, AFFILIATES_PRO_PLUGIN_DOMAIN ), $referrals ) . '</div>'; $IXAP34 .= '<div class="ratio">' . sprintf( __( '%.3f Ratio', AFFILIATES_PRO_PLUGIN_DOMAIN ), $IXAP259 ) . '</div>'; $show_totals = isset( $IXAP24['show_totals'] ) ? ( $IXAP24['show_totals'] !== 'false' ) : true; $show_totals_accepted = isset( $IXAP24['show_totals_accepted'] ) ? ( $IXAP24['show_totals_accepted'] === true || $IXAP24['show_totals_accepted'] === 'true' ) : false; $show_totals_pending = isset( $IXAP24['show_totals_pending'] ) ? ( $IXAP24['show_totals_pending'] === true || $IXAP24['show_totals_pending'] === 'true' ) : false; $show_totals_closed = isset( $IXAP24['show_totals_closed'] ) ? ( $IXAP24['show_totals_closed'] === true || $IXAP24['show_totals_closed'] === 'true' ) : false; $show_totals_rejected = isset( $IXAP24['show_totals_rejected'] ) ? ( $IXAP24['show_totals_rejected'] === true || $IXAP24['show_totals_rejected'] === 'true' ) : false; if ( $show_totals && ( $show_totals_accepted || $show_totals_pending || $show_totals_closed || $show_totals_rejected ) ) { $IXAP260 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $referrals_table WHERE affiliate_id = %d AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $affiliate_id, AFFILIATES_REFERRAL_STATUS_ACCEPTED ); $IXAP261 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $referrals_table WHERE affiliate_id = %d AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $affiliate_id, AFFILIATES_REFERRAL_STATUS_PENDING ); $IXAP262 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $referrals_table WHERE affiliate_id = %d AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $affiliate_id, AFFILIATES_REFERRAL_STATUS_CLOSED ); $IXAP263 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $referrals_table WHERE affiliate_id = %d AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $affiliate_id, AFFILIATES_REFERRAL_STATUS_REJECTED ); $IXAP34 .= '<div class="totals">'; $IXAP34 .= '<table cellpadding="0" cellspacing="0">'; $IXAP34 .= '<thead>'; $IXAP34 .= '<tr>'; $IXAP34 .= "<th scope='col' class='total'>" . __( 'Total', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP34 .= "<th scope='col' class='amount'>" . __( 'Amount', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP34 .= "<th scope='col' class='currency'>" . __( 'Currency', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP34 .= '</tr>'; $IXAP34 .= '</thead>'; $IXAP34 .= '<tbody>'; if ( $show_totals_accepted ) { if ( count( $IXAP260 ) == 0 ) { $IXAP260[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP260 as $IXAP23 ) { $IXAP34 .= '<tr>'; $IXAP34 .= "<td class='total accepted'>" . __( 'Accepted', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP34 .= "<td class='amount'>$IXAP23->total</td>"; $IXAP34 .= "<td class='currency'>$IXAP23->currency_id</td>"; $IXAP34 .= '</tr>'; } } if ( $show_totals_pending ) { if ( count( $IXAP261 ) == 0 ) { $IXAP261[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP261 as $IXAP23 ) { $IXAP34 .= '<tr>'; $IXAP34 .= "<td class='total pending'>" . __( 'Pending', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP34 .= "<td class='amount'>$IXAP23->total</td>"; $IXAP34 .= "<td class='currency'>$IXAP23->currency_id</td>"; $IXAP34 .= '</tr>'; } } if ( $show_totals_closed ) { if ( count( $IXAP262 ) == 0 ) { $IXAP262[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP262 as $IXAP23 ) { $IXAP34 .= '<tr>'; $IXAP34 .= "<td class='total closed'>" . __( 'Closed', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP34 .= "<td class='amount'>$IXAP23->total</td>"; $IXAP34 .= "<td class='currency'>$IXAP23->currency_id</td>"; $IXAP34 .= '</tr>'; } } if ( $show_totals_rejected ) { if ( count( $IXAP263 ) == 0 ) { $IXAP263[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP263 as $IXAP23 ) { $IXAP34 .= '<tr>'; $IXAP34 .= "<td class='total rejected'>" . __( 'Rejected', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP34 .= "<td class='amount'>$IXAP23->total</td>"; $IXAP34 .= "<td class='currency'>$IXAP23->currency_id</td>"; $IXAP34 .= '</tr>'; } } $IXAP34 .= '</tbody>'; $IXAP34 .= '</table>'; $IXAP34 .= '</div>'; } return $IXAP34; } }?>