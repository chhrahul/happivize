<?php
class Affiliates_Attributes_WordPress extends Affiliates_Attributes { function view( $affiliate_id ) { global $wpdb, $affiliates_options, $affiliates_db; $IXAP34 = ''; $IXAP101 = new Affiliates_Affiliate_WordPress(); $affiliate = $IXAP101->get_affiliate( $affiliate_id ); if ( $affiliate ) { $IXAP59 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP59 = remove_query_arg( 'action', $IXAP59 ); $IXAP59 = remove_query_arg( 'affiliate_id', $IXAP59 ); $IXAP247 = isset( $_POST['row_count'] ) ? intval( $_POST['row_count'] ) : 0; if ($IXAP247 <= 0) { $IXAP247 = $affiliates_options->get_option( 'affiliates_attributes_per_page', AFFILIATES_HITS_PER_PAGE ); } else { $affiliates_options->update_option('affiliates_attributes_per_page', $IXAP247 ); } $IXAP248 = isset( $_GET['offset'] ) ? intval( $_GET['offset'] ) : 0; if ( $IXAP248 < 0 ) { $IXAP248 = 0; } $IXAP249 = isset( $_REQUEST['paged'] ) ? intval( $_REQUEST['paged'] ) : 0; if ( $IXAP249 < 0 ) { $IXAP249 = 0; } $IXAP34 .= '<div class="manage-affiliates">' . '<div>' . '<h2>' . __( 'Affiliate Attributes', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h2>' . '</div>'; $IXAP34 .= '<div class="manage">' . "<a title='" . __( 'Click to add a new attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "' class='add' href='" . esc_url( $IXAP59 ) . "&action=add-attribute&affiliate_id=" . urlencode( $affiliate_id ) . "'><img class='icon' alt='" . __( 'Add', AFFILIATES_PRO_PLUGIN_DOMAIN) . "' src='". AFFILIATES_PRO_PLUGIN_URL ."images/add.png'/><span class='label'>" . __( 'New Attribute', AFFILIATES_PRO_PLUGIN_DOMAIN) . "</span></a>" . '</div>'; $IXAP34 .= '<div class="affiliates-attributes-overview">'; $IXAP105 = array( 'attr_key' => __( 'Id', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'attr_value' => __( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'edit' => __( 'Edit', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'remove' => __( 'Remove', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); $IXAP34 .= '
				<table id="" class="wp-list-table widefat fixed" cellspacing="0">
				<thead>
					<tr>
					'; foreach ( $IXAP105 as $key => $IXAP106 ) { $IXAP34 .= "<th scope='col' class='$key'>$IXAP106</th>"; } $IXAP34 .= '</tr>
				</thead>
				<tbody>
				'; $affiliates_attributes_table = $affiliates_db->get_tablename( "affiliates_attributes" ); $IXAP31 = $affiliates_db->get_objects("SELECT * FROM $affiliates_attributes_table WHERE affiliate_id = %d", $affiliate_id ); if ( !empty( $IXAP31 ) ) { $keys = Affiliates_Attributes::get_keys(); $i = 0; foreach ( $IXAP31 as $IXAP282 ) { $IXAP112 = ''; $IXAP113 = ''; $IXAP34 .= '<tr class="' . $IXAP112 . $IXAP113 . ( $i % 2 == 0 ? 'even' : 'odd' ) . '">'; $IXAP34 .= '<td>' . wp_filter_kses( $keys[$IXAP282->attr_key] ) . '</td>'; $IXAP283 = @unserialize( $IXAP282->attr_value ); if ( $IXAP283 !== false ) { $value = $IXAP283; } else { $value = $IXAP282->attr_value; } if ( is_array( $value ) ) { $value = implode( "::", $value ); } $IXAP34 .= '<td>' . wp_filter_kses( $value ) . '</td>'; $IXAP34 .= "<td class='edit'><a href='" . esc_url( $IXAP59 ) . "&action=edit-attribute&affiliate_id=" . urlencode( $affiliate_id ) . "&attr_key=" . urlencode( $IXAP282->attr_key ) . "' alt='" . __( 'Edit', AFFILIATES_PRO_PLUGIN_DOMAIN) . "'><img src='". AFFILIATES_PRO_PLUGIN_URL ."images/edit.png'/></a></td>"; $IXAP34 .= "<td class='remove'><a href='" . esc_url( $IXAP59 ) . "&action=remove-attribute&affiliate_id=" . urlencode( $affiliate_id ) . "&attr_key=" . urlencode( $IXAP282->attr_key ) . "' alt='" . __( 'Remove', AFFILIATES_PRO_PLUGIN_DOMAIN) . "'><img src='". AFFILIATES_PRO_PLUGIN_URL ."images/remove.png'/></a></td>"; $IXAP34 .= '</tr>'; $i++; } $IXAP34 .= '</table>'; $IXAP34 .= '</td>'; $IXAP34 .= '</tr>'; } else { $IXAP34 .= '<tr><td colspan="' . count( $IXAP105 ) . '">' . __('There are no results.', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</td></tr>'; } $IXAP34 .= '</tbody>'; $IXAP34 .= '</table>'; $IXAP34 .= '</div>'; $IXAP34 .= '</div>'; } echo $IXAP34; } function add( $affiliate_id ) { global $affiliates_db; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } affiliates_pro_admin_notices(); $IXAP59 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP59 = remove_query_arg( 'action', $IXAP59 ); $IXAP59 = remove_query_arg( 'affiliate_id', $IXAP59 ); $IXAP284 = esc_url( $IXAP59 ) . "&action=edit&affiliate_id=" . urlencode( $affiliate_id ); $IXAP59 = remove_query_arg( 'paged', $IXAP59 ); $affiliate_id = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : $affiliate_id; $IXAP201 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : ''; $IXAP204 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : ''; $IXAP285 = array(); $affiliates_attributes_table = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP286 = $affiliates_db->get_objects( "SELECT * FROM $affiliates_attributes_table WHERE affiliate_id = %d", $affiliate_id ); foreach( $IXAP286 as $IXAP287 ) { $IXAP285[] = $IXAP287->attr_key; } $key_select = '<select id="attr-key-field" name="attr-key-field" class="attr-key-field">'; $keys = Affiliates_Attributes::get_keys(); foreach( $keys as $key => $name ) { if ( !in_array( $key, $IXAP285 ) ) { $selected = $IXAP201 == $key ? ' selected="selected" ' : ''; $key_select .= '<option value="' . esc_attr( $key ) . '" ' . $selected . '>' . wp_filter_kses( $name ) . '</option>'; } } $key_select .= '</select>'; $IXAP34 = '<div class="manage-affiliates">' . '<div>' . '<h1>' . __( 'Add a new attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h1>' . '</div>' . '<form id="add-attribute" action="' . esc_url( $IXAP59 ) . '" method="post">' . '<div class="affiliate new">' . '<div class="field">' . '<label for="attr-key-field" class="field-label first required">' .__( 'Key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . $key_select . '</div>' . '<div class="field">' . '<label for="attr-value-field" class="field-label first required">' .__( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input id="attr-value-field" name="attr-value-field" class="attr-value-field" type="text" value="' . esc_attr( $IXAP204 ) . '"/>' . '</div>' . '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button button-primary" type="submit" value="' . __( 'Add', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="' . esc_attr( $affiliate_id ) . '" name="affiliate_id"/>' . '<input type="hidden" value="add-attribute" name="action"/>' . ' ' . '<a class="cancel button" href="' . $IXAP284 . '">' . __( 'Cancel', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IXAP34; } function add_submit() { global $wpdb, $affiliates_db, $affiliates_pro_admin_messages; $IXAP11 = true; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $affiliates_attributes_table = $affiliates_db->get_tablename( 'affiliates_attributes' ); $affiliate_id = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : null; $IXAP201 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : null; $IXAP204 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : null; if ( $IXAP204 !== null ) { $IXAP204 = Affiliates_Attributes::validate_value( $IXAP201, $IXAP204 ); if ( $IXAP204 !== false ) { if ( is_array( $IXAP204 ) || is_object( $IXAP204 ) ) { $IXAP204 = serialize( $IXAP204 ); } } else { $IXAP204 = null; } } $IXAP288 = false; if ( ( $IXAP201 == Affiliates_Attributes::IXAP129 ) && !empty( $IXAP204 ) ) { $IXAP289 = explode( ",", $IXAP204 ); foreach( $IXAP289 as $IXAP290 ) { $IXAP290 = trim( $IXAP290 ); $IXAP291 = self::get_affiliate_for_coupon( $IXAP290 ); if ( ( $IXAP291 !== null ) && ( $IXAP291 != $affiliate_id ) ) { $affiliates_pro_admin_messages[] = '<div class="error">' . sprintf( __( 'Coupons may not be assigned to multiple affiliates. The coupon code <strong>%s</strong> has already been assigned to the affiliate with Id %d.', AFFILIATES_PRO_PLUGIN_DOMAIN), $IXAP290, $IXAP291 ) . '</div>'; $IXAP288 = true; } } } if ( $IXAP288 ) { return false; } if ( !empty( $affiliate_id ) && Affiliates_Attributes::validate_key( $IXAP201 ) && ( $IXAP204 !== null ) ) { if ( !$affiliates_db->get_value( "SELECT * FROM $affiliates_attributes_table WHERE affiliate_id = %d AND attr_key = %s", $affiliate_id, $IXAP201 ) ) { if ( $affiliates_db->query( "INSERT INTO $affiliates_attributes_table SET affiliate_id=%d, attr_key=%s, attr_value=%s", $affiliate_id, $IXAP201, $IXAP204 ) ) { do_action( 'affiliates_added_attribute', $affiliate_id, $IXAP201, $IXAP204 ); } } else { $affiliates_pro_admin_messages[] = '<div class="error">' . __( 'Duplicate key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP11 = false; } } else { $affiliates_pro_admin_messages[] = '<div class="error">' . __( 'Invalid data', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP11 = false; } return $IXAP11; } function edit( $affiliate_id, $IXAP201 ) { global $affiliates_db; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } affiliates_pro_admin_notices(); $IXAP59 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP59 = remove_query_arg( 'action', $IXAP59 ); $IXAP59 = remove_query_arg( 'affiliate_id', $IXAP59 ); $IXAP284 = esc_url( $IXAP59 ) . "&action=edit&affiliate_id=" . urlencode( $affiliate_id ); $IXAP59 = remove_query_arg( 'paged', $IXAP59 ); $affiliates_attributes_table = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP204 = $affiliates_db->get_value( "SELECT attr_value FROM $affiliates_attributes_table WHERE affiliate_id = %d AND attr_key = %s", $affiliate_id, $IXAP201 ); $affiliate_id = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : $affiliate_id; $IXAP201 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : $IXAP201; $IXAP204 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : $IXAP204; $IXAP292 = @unserialize( $IXAP204 ); if ( $IXAP292 === false ) { $IXAP292 = $IXAP204; } if ( is_array( $IXAP292 ) ) { $IXAP292 = implode( "::", $IXAP292 ); } $keys = Affiliates_Attributes::get_keys(); $IXAP34 = '<div class="manage-affiliates">' . '<div>' . '<h1>' . __( 'Edit an attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h1>' . '</div>' . '<form id="edit-attribute" action="' . esc_url( $IXAP59 ) . '" method="post">' . '<div class="affiliate-attribute edit">' . '<div class="field">' . '<label for="attr-key-field" class="field-label first required">' .__( 'Key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input readonly="readonly" id="attr-name-field" name="attr-name-field" class="attr-name-field" type="text" value="' . esc_attr( $keys[$IXAP201] ) . '"/>' . '<input type="hidden" name="attr-key-field" value="' . esc_attr( $IXAP201 ) . '"/>' . '</div>' . '<div class="field">' . '<label for="attr-value-field" class="field-label first required">' .__( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input id="attr-value-field" name="attr-value-field" class="attr-value-field" type="text" value="' . esc_attr( $IXAP292 ) . '"/>' . '</div>' . '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button button-primary" type="submit" value="' . __( 'Save', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="' . esc_attr( $affiliate_id ) . '" name="affiliate_id"/>' . '<input type="hidden" value="edit-attribute" name="action"/>' . ' ' . '<a class="cancel button" href="' . $IXAP284 . '">' . __( 'Cancel', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IXAP34; } function edit_submit() { global $wpdb, $affiliates_db, $affiliates_pro_admin_messages; $IXAP11 = true; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $affiliates_attributes_table = $affiliates_db->get_tablename( 'affiliates_attributes' ); $affiliate_id = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : null; $IXAP201 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : null; $IXAP204 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : null; if ( $IXAP204 !== null ) { $IXAP204 = Affiliates_Attributes::validate_value( $IXAP201, $IXAP204 ); if ( $IXAP204 !== false ) { if ( is_array( $IXAP204 ) || is_object( $IXAP204 ) ) { $IXAP204 = serialize( $IXAP204 ); } } else { $IXAP204 = null; } } $IXAP288 = false; if ( ( $IXAP201 == Affiliates_Attributes::IXAP129 ) && !empty( $IXAP204 ) ) { $IXAP289 = explode( ",", $IXAP204 ); foreach( $IXAP289 as $IXAP290 ) { $IXAP290 = trim( $IXAP290 ); $IXAP291 = self::get_affiliate_for_coupon( $IXAP290 ); if ( ( $IXAP291 !== null ) && ( $IXAP291 != $affiliate_id ) ) { $affiliates_pro_admin_messages[] = '<div class="error">' . sprintf( __( 'Coupons may not be assigned to multiple affiliates. The coupon code <strong>%s</strong> has already been assigned to the affiliate with Id %d.', AFFILIATES_PRO_PLUGIN_DOMAIN), $IXAP290, $IXAP291 ) . '</div>'; $IXAP288 = true; } } } if ( $IXAP288 ) { return false; } if ( !empty( $affiliate_id ) && Affiliates_Attributes::validate_key( $IXAP201 ) && ( $IXAP204 !== null ) ) { if ( $IXAP266 = $affiliates_db->get_value( "SELECT attr_value FROM $affiliates_attributes_table WHERE affiliate_id = %d AND attr_key = %s", $affiliate_id, $IXAP201 ) ) { if ( $affiliates_db->query( "UPDATE $affiliates_attributes_table SET attr_value=%s WHERE affiliate_id=%d AND attr_key=%s", $IXAP204 , $affiliate_id, $IXAP201 ) ) { do_action( 'affiliates_updated_attribute', $affiliate_id, $IXAP201, $IXAP266, $IXAP204 ); } } else { $affiliates_pro_admin_messages[] = '<div class="error">' . __( 'Invalid key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP11 = false; } } else { $affiliates_pro_admin_messages[] = '<div class="error">' . __( 'Invalid data', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP11 = false; } return $IXAP11; } function remove( $affiliate_id, $IXAP201 ) { global $affiliates_db; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } affiliates_pro_admin_notices(); $IXAP59 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP59 = remove_query_arg( 'action', $IXAP59 ); $IXAP59 = remove_query_arg( 'affiliate_id', $IXAP59 ); $IXAP284 = esc_url( $IXAP59 ) . "&action=edit&affiliate_id=" . urlencode( $affiliate_id ); $IXAP59 = remove_query_arg( 'paged', $IXAP59 ); $affiliates_attributes_table = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP204 = $affiliates_db->get_value( "SELECT attr_value FROM $affiliates_attributes_table WHERE affiliate_id = %d AND attr_key = %s", $affiliate_id, $IXAP201 ); $affiliate_id = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : $affiliate_id; $IXAP201 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : $IXAP201; $IXAP204 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : $IXAP204; $IXAP292 = @unserialize( $IXAP204 ); if ( $IXAP292 === false ) { $IXAP292 = $IXAP204; } if ( is_array( $IXAP292 ) ) { $IXAP292 = implode( "::", $IXAP292 ); } $keys = Affiliates_Attributes::get_keys(); $IXAP34 = '<div class="manage-affiliates">' . '<div>' . '<h1>' . __( 'Remove an attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h1>' . '</div>' . '<form id="remove-attribute" action="' . esc_url( $IXAP59 ) . '" method="post">' . '<div class="affiliate-attribute remove">' . '<div class="field">' . '<label for="attr-key-field" class="field-label first required">' .__( 'Key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input readonly="readonly" id="attr-name-field" name="attr-name-field" class="attr-name-field" type="text" value="' . esc_attr( $keys[$IXAP201] ) . '"/>' . '<input type="hidden" name="attr-key-field" value="' . esc_attr( $IXAP201 ) . '"/>' . '</div>' . '<div class="field">' . '<label for="attr-value-field" class="field-label first required">' .__( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input readonly="readonly" id="attr-value-field" name="attr-value-field" class="attr-value-field" type="text" value="' . esc_attr( $IXAP292 ) . '"/>' . '</div>' . '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button button-primary" type="submit" value="' . __( 'Remove', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="' . esc_attr( $affiliate_id ) . '" name="affiliate_id"/>' . '<input type="hidden" value="remove-attribute" name="action"/>' . ' ' . '<a class="cancel button" href="' . $IXAP284 . '">' . __( 'Cancel', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IXAP34; } function remove_submit() { global $wpdb, $affiliates_db, $affiliates_pro_admin_messages; $IXAP11 = true; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $affiliates_attributes_table = $affiliates_db->get_tablename( 'affiliates_attributes' ); $affiliate_id = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : null; $IXAP201 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : null; if ( !( empty( $affiliate_id ) || empty( $IXAP201 ) ) ) { $IXAP204 = $affiliates_db->get_value( "SELECT attr_value FROM $affiliates_attributes_table WHERE affiliate_id = %d AND attr_key = %s", $affiliate_id, $IXAP201 ); if ( $affiliates_db->query( "DELETE FROM $affiliates_attributes_table WHERE affiliate_id=%d AND attr_key=%s", $affiliate_id, $IXAP201 ) ) { do_action( 'affiliates_removed_attribute', $affiliate_id, $IXAP201, $IXAP204 ); } } else { $IXAP11 = false; } return $IXAP11; } public static function get_affiliate_for_coupon( $IXAP290 ) { global $affiliates_db; $affiliates_attributes_table = $affiliates_db->get_tablename( "affiliates_attributes" ); $affiliates_coupons = $affiliates_db->get_objects( "SELECT * FROM $affiliates_attributes_table WHERE attr_key = %s AND attr_value LIKE '%%%s%%'", Affiliates_Attributes::IXAP129, $IXAP290 ); $affiliate_id = null; foreach( $affiliates_coupons as $affiliate_coupons ) { $IXAP293 = explode( ",", $affiliate_coupons->attr_value ); foreach( $IXAP293 as $IXAP294 ) { $IXAP294 = trim( $IXAP294 ); if ( apply_filters( 'affiliates_coupons_equality_test', $IXAP294 === $IXAP290, $IXAP294, $IXAP290 ) ) { $affiliate_id = $affiliate_coupons->affiliate_id; break; } } if ( $affiliate_id !== null ) { break; } } return apply_filters( 'affiliates_coupon_affiliate_id', $affiliate_id, $IXAP290 ); } public static function get_coupons_for_affiliate( $affiliate_id ) { global $affiliates_db; $IXAP11 = array(); $affiliates_attributes_table = $affiliates_db->get_tablename( 'affiliates_attributes' ); if ( $IXAP289 = $affiliates_db->get_value( "SELECT attr_value FROM $affiliates_attributes_table WHERE affiliate_id = %d AND attr_key = %s", intval( $affiliate_id ), Affiliates_Attributes::IXAP129 ) ) { $IXAP11 = explode( ',', $IXAP289 ); } return $IXAP11; } public static function set_coupons_for_affiliate( $affiliate_id, $IXAP289 = array() ) { global $affiliates_db; $affiliate_id = intval( $affiliate_id ); $IXAP295 = array(); foreach( $IXAP289 as $IXAP290 ) { $IXAP290 = trim( $IXAP290 ); if ( strlen( $IXAP290 ) > 0 ) { $IXAP291 = self::get_affiliate_for_coupon( $IXAP290 ); if ( ( $IXAP291 === null ) || ( $IXAP291 == $affiliate_id ) ) { $IXAP295[] = $IXAP290; } } } $IXAP289 = $IXAP295; $IXAP296 = self::get_coupons_for_affiliate( $affiliate_id ); if ( $IXAP296 != $IXAP289 ) { $affiliates_attributes_table = $affiliates_db->get_tablename( 'affiliates_attributes' ); if ( count( $IXAP289 ) == 0 ) { if ( $affiliates_db->query( "DELETE FROM $affiliates_attributes_table WHERE affiliate_id=%d AND attr_key=%s", $affiliate_id, $IXAP201 ) ) { do_action( 'affiliates_removed_attribute', $affiliate_id, Affiliates_Attributes::IXAP129, implode( ',', $IXAP296 ) ); } } else { if ( $IXAP266 = $affiliates_db->get_value( "SELECT attr_value FROM $affiliates_attributes_table WHERE affiliate_id = %d AND attr_key = %s", $affiliate_id, Affiliates_Attributes::IXAP129 ) ) { if ( $affiliates_db->query( "UPDATE $affiliates_attributes_table SET attr_value=%s WHERE affiliate_id=%d AND attr_key=%s", implode( ',', $IXAP289 ) , $affiliate_id, Affiliates_Attributes::IXAP129 ) ) { do_action( 'affiliates_updated_attribute', $affiliate_id, Affiliates_Attributes::IXAP129, $IXAP266, implode( ',', $IXAP289 ) ); } } else { if ( $affiliates_db->query( "INSERT INTO $affiliates_attributes_table SET affiliate_id=%d, attr_key=%s, attr_value=%s", $affiliate_id, Affiliates_Attributes::IXAP129, implode( ',', $IXAP289 ) ) ) { do_action( 'affiliates_added_attribute', $affiliate_id, Affiliates_Attributes::IXAP129, implode( ',', $IXAP289 ) ); } } } } } } 