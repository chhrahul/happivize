<?php
class Affiliates_Referral_WordPress extends Affiliates_Referral { public function suggest( $post_id, $IXAP72 = '', $data = null, $amount = null, $currency_id = null, $status = null ) { trigger_error( __FUNCTION__ . " is deprecated", E_USER_WARNING ); return $this->evaluate( $post_id, $IXAP72, $data, null, $amount, $currency_id, $status ); } public function evaluate( $post_id, $IXAP72 = '', $data = null, $IXAP220 = null, $amount = null, $currency_id = null, $status = null, $type = null, $reference = null, $IXAP221 = false ) { require_once( AFFILIATES_CORE_LIB . '/class-affiliates-service.php' ); $affiliate_id = Affiliates_Service::get_referrer_id(); if ( !$IXAP221 ) { if ( $affiliate_id ) { $IXAP321 = Affiliates_Service::get_hit_id(); $affiliate_ids = array ( $affiliate_id ); $this->add_referrals( $affiliate_ids, $post_id, $IXAP72, $data, $IXAP220, $amount, $currency_id, $status, $type, $reference, false, $IXAP321 ); } } return $affiliate_id; } public function suggest_by_attribute( $IXAP222, $IXAP223, $post_id, $IXAP72 = '', $data = null, $IXAP220 = null, $amount = null, $currency_id = null, $status = null, $type = null, $reference = null, $IXAP221 = false ) { global $wpdb, $affiliates_options; global $affiliates_db; bcscale( AFFILIATES_REFERRAL_AMOUNT_DECIMALS ); $affiliates_table = $affiliates_db->get_tablename( "affiliates" ); $affiliates_attributes_table = $affiliates_db->get_tablename( "affiliates_attributes" ); $now = date( 'Y-m-d H:i:s', time() ); $IXAP83 = date( 'Y-m-d', time() ); $affiliate_ids = $affiliates_db->get_objects( "SELECT a.affiliate_id FROM $affiliates_table a
			LEFT JOIN $affiliates_attributes_table aa ON a.affiliate_id = aa.affiliate_id
			WHERE
			aa.attr_key = %s
			AND aa.attr_value = %s
			AND a.from_date <= %s AND ( a.thru_date IS NULL OR a.thru_date >= %s )
			AND a.status = 'active'
			", $IXAP222, $IXAP223, $IXAP83, $IXAP83 ); if ( empty( $affiliate_ids ) ) { if ( get_option( 'aff_use_direct', true ) ) { $affiliate_ids = array ( (object) array( 'affiliate_id' => affiliates_get_direct_id() ) ); } } if ( !$IXAP221 ) { $IXAP322 = array(); foreach ( $affiliate_ids as $affiliate_id ) { $IXAP322[] = $affiliate_id->affiliate_id; } $this->add_referrals( $IXAP322, $post_id, $IXAP72, $data, $IXAP220, $amount, $currency_id, $status, $type, $reference, $IXAP221 ); } return $affiliate_ids; } public function add_referrals( $affiliate_ids, $post_id, $IXAP72 = '', $data = null, $IXAP220 = null, $amount = null, $currency_id = null, $status = null, $type = null, $reference = null, $IXAP221 = false, $IXAP321 = null ) { global $affiliates_db; $affiliates_table = $affiliates_db->get_tablename( "affiliates" ); $affiliates_attributes_table = $affiliates_db->get_tablename( "affiliates_attributes" ); $now = date( 'Y-m-d H:i:s', time() ); $IXAP83 = date( 'Y-m-d', time() ); bcscale( AFFILIATES_REFERRAL_AMOUNT_DECIMALS ); if ( !empty( $affiliate_ids ) ) { foreach ( $affiliate_ids as $affiliate_id ) { $IXAP323 = wp_get_current_user(); $now = date('Y-m-d H:i:s', time() ); $IXAP73 = $affiliates_db->get_tablename( 'referrals' ); $IXAP62 = "(affiliate_id, post_id, datetime, description"; $IXAP270 = "(%d, %d, %s, %s"; $values = array($affiliate_id, $post_id, $now, $IXAP72); if ( !empty( $IXAP323 ) ) { $IXAP62 .= ",user_id "; $IXAP270 .= ",%d "; $values[] = $IXAP323->ID; } $ip_address = $_SERVER['REMOTE_ADDR']; if ( PHP_INT_SIZE >= 8 ) { if ( $ip_int = ip2long( $ip_address ) ) { $IXAP62 .= ',ip '; $IXAP270 .= ',%d '; $values[] = $ip_int; } } else { if ( $ip_int = ip2long( $ip_address ) ) { $ip_int = sprintf( '%u', $ip_int ); $IXAP62 .= ',ip'; $IXAP270 .= ',%s'; $values[] = $ip_int; } } if ( !empty( $currency_id ) ) { if ( empty( $amount ) ) { $affiliate_attrs = $affiliates_db->get_objects( "SELECT * FROM $affiliates_attributes_table
								WHERE
								affiliate_id = %d
								AND attr_key IN ('referral.rate','referral.rate.method','referral.amount','referral.amount.method')
								", $affiliate_id ); $referral_amount_amount = null; $referral_amount_method_amount = null; $referral_rate_amount = null; foreach( $affiliate_attrs as $affiliate_attr ) { switch( $affiliate_attr->attr_key ) { case 'referral.amount' : $referral_amount_amount = bcadd( "0", $affiliate_attr->attr_value ); break; case 'referral.amount.method' : $referral_amount_method_amount = bcadd( "0", call_user_func( Affiliates_Referral::get_referral_amount_method( $affiliate_attr->attr_value ), $affiliate_id, array( "affiliate_ids" => $affiliate_ids, "post_id" => $post_id, "description" => $IXAP72, "data" => $data, "base_amount" => $IXAP220, "amount" => $amount, "currency_id" => $currency_id, "status" => $status, "type" => $type, "reference" => $reference, "test" => $IXAP221 ) ) ); break; case 'referral.rate' : $referral_rate_amount = bcmul( $IXAP220, $affiliate_attr->attr_value ); break; } } if ( $referral_amount_amount ) { $amount = $referral_amount_amount; } else if ( $referral_amount_method_amount ) { $amount = $referral_amount_method_amount; } else if ( $referral_rate_amount ) { $amount = $referral_rate_amount; } else { if ( $IXAP324 = Affiliates_Attributes::validate_key( get_option( self::IXAP121, null ) ) ) { if ( $IXAP325 = Affiliates_Attributes::validate_value( $IXAP324, get_option( self::IXAP122, null ) ) ) { switch ( $IXAP324 ) { case 'referral.amount' : $amount = bcadd( "0", $IXAP325 ); break; case 'referral.amount.method' : $amount = bcadd( "0", call_user_func( Affiliates_Referral::get_referral_amount_method( $IXAP325 ), $affiliate_id, array( "affiliate_ids" => $affiliate_ids, "post_id" => $post_id, "description" => $IXAP72, "data" => $data, "base_amount" => $IXAP220, "amount" => $amount, "currency_id" => $currency_id, "status" => $status, "type" => $type, "reference" => $reference, "test" => $IXAP221 ) ) ); break; case 'referral.rate' : $amount = bcmul( $IXAP220, $IXAP325 ); break; } } } } } if ( !empty( $amount ) ) { if ( $amount = Affiliates_Utility::verify_referral_amount( $amount ) ) { if ( $currency_id = Affiliates_Utility::verify_currency_id( $currency_id ) ) { $IXAP62 .= ",amount "; $IXAP270 .= ",%s "; $values[] = $amount; $IXAP62 .= ",currency_id "; $IXAP270 .= ",%s "; $values[] = $currency_id; } } } } if ( is_array( $data ) && !empty( $data ) ) { $IXAP62 .= ",data "; $IXAP270 .= ",%s "; $values[] = serialize( $data ); } if ( !empty( $status ) && Affiliates_Utility::verify_referral_status_transition( $status, $status ) ) { $IXAP62 .= ',status '; $IXAP270 .= ',%s '; $values[] = $status; } else { $IXAP62 .= ',status '; $IXAP270 .= ',%s '; $values[] = get_option( 'aff_default_referral_status', AFFILIATES_REFERRAL_STATUS_ACCEPTED ); } if ( !empty( $type ) ) { $IXAP62 .= ',type '; $IXAP270 .= ',%s '; $values[] = $type; } if ( !empty( $reference ) ) { $IXAP62 .= ',reference '; $IXAP270 .= ',%s '; $values[] = $reference; } if ( !empty( $IXAP321 ) ) { $IXAP62 .= ',hit_id '; $IXAP270 .= ',%d'; $values[] = intval( $IXAP321 ); } $IXAP12 = null; require_once( AFFILIATES_CORE_LIB . '/class-affiliates-service.php' ); if ( $service_ids = Affiliates_Service::get_ids() ) { if ( !empty( $service_ids['affiliate_id'] ) && !empty( $service_ids['campaign_id'] ) ) { if ( $service_ids['affiliate_id'] == $affiliate_id ) { $IXAP62 .= ',campaign_id '; $IXAP270 .= ',%d '; $IXAP12 = intval( $service_ids['campaign_id'] ); $values[] = $IXAP12; } } } $IXAP62 .= ")"; $IXAP270 .= ")"; if ( !$IXAP221 ) { $keys = explode( ',', str_replace( ' ', '', substr( $IXAP62, 1, strlen( $IXAP62 ) - 2 ) ) ); $referral_data = array_combine( $keys, $values ); $IXAP326 = apply_filters( 'affiliates_record_referral', true, $referral_data ); if ( $IXAP326 ) { if ( !affiliates_is_duplicate_referral( array( 'affiliate_id' => $affiliate_id, 'amount' => $amount, 'currency_id' => $currency_id, 'type' => $type, 'reference' => $reference, 'data' => $data ) ) ) { if ( $affiliates_db->query( "INSERT INTO $IXAP73 $IXAP62 VALUES $IXAP270", $values ) !== false ) { if ( $referral_id = $affiliates_db->get_value( "SELECT LAST_INSERT_ID()" ) ) { do_action( 'affiliates_referral', $referral_id, array( 'affiliate_id' => $affiliate_id, 'post_id' => $post_id, 'description' => $IXAP72, 'data' => $data, 'base_amount' => $IXAP220, 'amount' => $amount, 'currency_id' => $currency_id, 'status' => $status, 'type' => $type, 'reference' => $reference, 'hit_id' => $IXAP321, 'test' => $IXAP221, 'campaign_id' => $IXAP12 ) ); } } } } } } } return $affiliate_ids; } public function __construct( $referral_id = null ) { if ( $referral_id !== null ) { global $affiliates_db; $referrals_table = $affiliates_db->get_tablename( 'referrals' ); if ( $referrals = $affiliates_db->get_objects( "SELECT * FROM $referrals_table WHERE referral_id = %d", $referral_id ) ) { if ( count( $referrals ) > 0 ) { $this->referral = $referrals[0]; } } if ( $this->referral === null ) { throw new Exception(); } } } public function update( $IXAP224 ) { global $affiliates_db; $IXAP11 = null; if ( $this->referral !== null ) { $set = array(); $keys = array(); $values = array(); $old_values = array(); foreach( $IXAP224 as $key => $value ) { $IXAP327 = isset( $this->referral->$key ) ? $this->referral->$key : null; if ( $IXAP327 !== $value ) { switch( $key ) { case 'affiliate_id' : case 'post_id' : case 'campaign_id' : case 'hit_id' : $set[] = " $key = %d "; $keys[] = $key; $values[] = intval( $value ); $old_values[] = $IXAP327; break; case 'datetime' : case 'description' : case 'reference' : $set[] = " $key = %s "; $keys[] = $key; $values[] = $value; $old_values[] = $IXAP327; break; case 'status' : if ( !empty( $value ) && Affiliates_Utility::verify_referral_status_transition( $value, $value ) ) { $set[] = " $key = %s "; $keys[] = $key; $values[] = $value; $old_values[] = $IXAP327; } break; case 'amount' : if ( $value = Affiliates_Utility::verify_referral_amount( $value ) ) { $set[] = " $key = %s "; $keys[] = $key; $values[] = $value; $old_values[] = $IXAP327; } break; case 'currency_id' : if ( $value = Affiliates_Utility::verify_currency_id( $value ) ) { $set[] = " $key = %s "; $keys[] = $key; $values[] = $value; $old_values[] = $IXAP327; } break; } } } if ( count( $set ) > 0 ) { $set = implode( ' , ', $set ); $referrals_table = $affiliates_db->get_tablename( 'referrals' ); if ( $affiliates_db->query( "UPDATE $referrals_table SET $set WHERE referral_id = %d", array_merge( $values, array( intval( $this->referral->referral_id ) ) ) ) ) { if ( $referrals = $affiliates_db->get_objects( "SELECT * FROM $referrals_table WHERE referral_id = %d", intval( $this->referral->referral_id ) ) ) { if ( count( $referrals ) > 0 ) { $this->referral = $referrals[0]; } } $IXAP11 = array( 'keys' => $keys, 'values' => $values, 'old_values' => $old_values ); do_action( 'affiliates_updated_referral', intval( $this->referral->referral_id ), $keys, $values, $old_values ); } } } return $IXAP11; } }