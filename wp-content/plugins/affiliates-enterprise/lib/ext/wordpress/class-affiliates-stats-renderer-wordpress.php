<?php
 class Affiliates_Stats_Renderer_WordPress extends Affiliates_Stats_Renderer { const NONCE = 'affiliate-nonce'; const NONCE_1 = 'affiliate-nonce-1'; const NONCE_2 = 'affiliate-nonce-2'; const NONCE_FILTERS = 'affiliate-nonce-filters'; static function init() { add_shortcode( 'affiliates_affiliate_stats', array( 'Affiliates_Stats_Renderer_WordPress', 'stats_shortcode' ) ); } static function stats_shortcode( $IXAP31, $IXAP32 = null ) { $IXAP11 = null; wp_enqueue_script( 'datepicker' ); wp_enqueue_script( 'datepickers' ); wp_enqueue_style( 'smoothness' ); wp_enqueue_style( 'affiliates-pro' ); $IXAP24 = shortcode_atts( self::$stats_defaults, $IXAP31 ); switch ( $IXAP24['type'] ) { case self::STATS_REFERRALS : $IXAP11 = Affiliates_Affiliate_Stats_Renderer_WordPress::render_referrals( $IXAP24 ); break; case self::STATS_SUMMARY : $IXAP11 = self::render_affiliate_stats( $IXAP24 ); break; } return $IXAP11; } static function render_affiliate_stats( $IXAP24 = array() ) { global $affiliates_options, $affiliates_db; $IXAP34 = ''; $affiliate_id = Affiliates_Affiliate_WordPress::get_user_affiliate_id(); if ( $affiliate_id === false ) { return $IXAP34; } $IXAP15 = $affiliates_options->get_option( 'affiliate_stats_from_date', null ); $IXAP16 = $affiliates_options->get_option( 'affiliate_stats_thru_date', null ); if ( isset( $_POST[self::NONCE_FILTERS] ) ) { if ( !wp_verify_nonce( $_POST[self::NONCE_FILTERS], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( isset( $_POST['clear_filters'] ) ) { $affiliates_options->delete_option( 'affiliate_stats_from_date' ); $affiliates_options->delete_option( 'affiliate_stats_thru_date' ); $IXAP15 = null; $IXAP16 = null; } else { if ( !empty( $_POST['from_date'] ) ) { $IXAP15 = date( 'Y-m-d', strtotime( $_POST['from_date'] ) ); $affiliates_options->update_option( 'affiliate_stats_from_date', $IXAP15 ); } if ( !empty( $_POST['thru_date'] ) ) { $IXAP16 = date( 'Y-m-d', strtotime( $_POST['thru_date'] ) ); $affiliates_options->update_option( 'affiliate_stats_thru_date', $IXAP16 ); } if ( $IXAP15 && $IXAP16 ) { if ( strtotime( $IXAP15 ) > strtotime( $IXAP16 ) ) { $IXAP16 = null; $affiliates_options->delete_option( 'affiliate_stats_thru_date' ); } } } } if ( $IXAP15 ) { $IXAP20 = DateHelper::u2s( $IXAP15 ); } if ( $IXAP16 ) { $IXAP21 = DateHelper::u2s( $IXAP16, 24*3600 ); } $affiliates_table = $affiliates_db->get_tablename( 'affiliates' ); $referrals_table = $affiliates_db->get_tablename( 'referrals' ); $IXAP18 = $affiliates_db->get_tablename( 'hits' ); if ( $IXAP15 || $IXAP16 || $affiliate_id ) { $IXAP179 = " WHERE "; } else { $IXAP179 = ''; } $IXAP180 = array(); if ( $IXAP15 && $IXAP16 ) { $IXAP179 .= " datetime >= %s AND datetime < %s "; $IXAP180[] = $IXAP20; $IXAP180[] = $IXAP21; } else if ( $IXAP15 ) { $IXAP179 .= " datetime >= %s "; $IXAP180[] = $IXAP20; } else if ( $IXAP16 ) { $IXAP179 .= " datetime < %s "; $IXAP180[] = $IXAP21; } if ( $affiliate_id ) { if ( $IXAP15 || $IXAP16 ) { $IXAP179 .= " AND "; } $IXAP179 .= " h.affiliate_id = %d "; $IXAP180[] = $affiliate_id; } $IXAP105 = array( 'visits' => __( 'Visits', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'hits' => __( 'Hits', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'referrals' => __( 'Referrals', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'ratio' => __( 'Ratio', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); $IXAP145 = affiliates_get_affiliate_visits( $affiliate_id, $IXAP15, $IXAP16 ); $IXAP142 = affiliates_get_affiliate_hits( $affiliate_id, $IXAP15, $IXAP16 ); $referrals = affiliates_get_affiliate_referrals( $affiliate_id, $IXAP15, $IXAP16 ); if ( $IXAP145 > 0 ) { $IXAP259 = round( $referrals / $IXAP145, self::IXAP225 ); } else { $IXAP259 = 0; } $IXAP34 .= '<div id="" class="affiliate-stats summary">'; $IXAP34 .= '
			<table class="wp-list-table widefat fixed" cellspacing="0">
			<thead>
				<tr>
				'; foreach ( $IXAP105 as $key => $IXAP106 ) { $IXAP34 .= "<th scope='col' class='$key'>$IXAP106</th>"; } $IXAP34 .= '</tr>
			</thead>
			<tbody>
			'; $IXAP34 .= '<tr>'; $IXAP34 .= "<td class='visits'>$IXAP145</td>"; $IXAP34 .= "<td class='hits'>$IXAP142</td>"; $IXAP34 .= "<td class='referrals'>$referrals</td>"; $IXAP34 .= "<td class='ratio'>$IXAP259</td>"; $IXAP34 .= '</tr>'; $IXAP34 .= '</tbody>'; $IXAP34 .= '</table>'; $show_totals = isset( $IXAP24['show_totals'] ) ? ( $IXAP24['show_totals'] !== 'false' ) : true; $show_totals_accepted = isset( $IXAP24['show_totals_accepted'] ) ? ( $IXAP24['show_totals_accepted'] === true || $IXAP24['show_totals_accepted'] === 'true' ) : false; $show_totals_pending = isset( $IXAP24['show_totals_pending'] ) ? ( $IXAP24['show_totals_pending'] === true || $IXAP24['show_totals_pending'] === 'true' ) : false; $show_totals_closed = isset( $IXAP24['show_totals_closed'] ) ? ( $IXAP24['show_totals_closed'] === true || $IXAP24['show_totals_closed'] === 'true' ) : false; $show_totals_rejected = isset( $IXAP24['show_totals_rejected'] ) ? ( $IXAP24['show_totals_rejected'] === true || $IXAP24['show_totals_rejected'] === 'true' ) : false; if ( $show_totals && ( $show_totals_accepted || $show_totals_pending || $show_totals_closed || $show_totals_rejected ) ) { $IXAP331 = ''; if ( $IXAP15 && $IXAP16 ) { $IXAP331 = " AND datetime >= '$IXAP20' AND datetime < '$IXAP21' "; } else if ( $IXAP15 ) { $IXAP331 = " AND datetime >= '$IXAP20' "; } else if ( $IXAP16 ) { $IXAP331 = " AND datetime < '$IXAP21' "; } $IXAP260 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $referrals_table WHERE affiliate_id = %d $IXAP331 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $affiliate_id, AFFILIATES_REFERRAL_STATUS_ACCEPTED ); $IXAP261 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $referrals_table WHERE affiliate_id = %d $IXAP331 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $affiliate_id, AFFILIATES_REFERRAL_STATUS_PENDING ); $IXAP262 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $referrals_table WHERE affiliate_id = %d $IXAP331 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $affiliate_id, AFFILIATES_REFERRAL_STATUS_CLOSED ); $IXAP263 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $referrals_table WHERE affiliate_id = %d $IXAP331 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $affiliate_id, AFFILIATES_REFERRAL_STATUS_REJECTED ); $IXAP34 .= '<table class="wp-list-table widefat fixed" cellspacing="0">'; $IXAP34 .= '<thead>'; $IXAP34 .= '<tr>'; $IXAP34 .= "<th scope='col' class='total'>" . __( 'Total', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP34 .= "<th scope='col' class='amount'>" . __( 'Amount', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP34 .= "<th scope='col' class='currency'>" . __( 'Currency', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</th>"; $IXAP34 .= '</tr>'; $IXAP34 .= '</thead>'; $IXAP34 .= '<tbody>'; if ( $show_totals_accepted ) { if ( count( $IXAP260 ) == 0 ) { $IXAP260[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP260 as $IXAP23 ) { $IXAP34 .= '<tr>'; $IXAP34 .= "<td class='total accepted'>" . __( 'Accepted', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP34 .= "<td class='amount'>$IXAP23->total</td>"; $IXAP34 .= "<td class='currency'>$IXAP23->currency_id</td>"; $IXAP34 .= '</tr>'; } } if ( $show_totals_pending ) { if ( count( $IXAP261 ) == 0 ) { $IXAP261[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP261 as $IXAP23 ) { $IXAP34 .= '<tr>'; $IXAP34 .= "<td class='total pending'>" . __( 'Pending', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP34 .= "<td class='amount'>$IXAP23->total</td>"; $IXAP34 .= "<td class='currency'>$IXAP23->currency_id</td>"; $IXAP34 .= '</tr>'; } } if ( $show_totals_closed ) { if ( count( $IXAP262 ) == 0 ) { $IXAP262[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP262 as $IXAP23 ) { $IXAP34 .= '<tr>'; $IXAP34 .= "<td class='total closed'>" . __( 'Closed', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP34 .= "<td class='amount'>$IXAP23->total</td>"; $IXAP34 .= "<td class='currency'>$IXAP23->currency_id</td>"; $IXAP34 .= '</tr>'; } } if ( $show_totals_rejected ) { if ( count( $IXAP263 ) == 0 ) { $IXAP263[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IXAP263 as $IXAP23 ) { $IXAP34 .= '<tr>'; $IXAP34 .= "<td class='total rejected'>" . __( 'Rejected', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "</td>"; $IXAP34 .= "<td class='amount'>$IXAP23->total</td>"; $IXAP34 .= "<td class='currency'>$IXAP23->currency_id</td>"; $IXAP34 .= '</tr>'; } } $IXAP34 .= '</tbody>'; $IXAP34 .= '</table>'; } $IXAP34 .= '<div class="filters">' . '<label class="description" for="setfilters">' . __( 'Filters', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<form id="setfilters" action="" method="post">' . '<div class="from-date">' . '<label class="from-date-filter" for="from_date">' . __('From', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<noscript><span class="description mini">' . __( 'Format: YYYY-MM-DD', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</span></noscript>' . '<input class="datefield from-date-filter" name="from_date" type="text" value="' . esc_attr( $IXAP15 ) . '"/>'. '</div>' . '<div class="thru-date">' . '<label class="thru-date-filter" for="thru_date">' . __('Until', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<noscript><span class="description mini">' . __( 'Format: YYYY-MM-DD', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</span></noscript>' . '<input class="datefield thru-date-filter" name="thru_date" type="text" class="datefield" value="' . esc_attr( $IXAP16 ) . '"/>'. '</div>' . '<div class="submit">' . wp_nonce_field( plugin_basename( __FILE__ ), self::NONCE_FILTERS, true, false ) . '<input type="submit" value="' . __( 'Apply', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="submit" name="clear_filters" value="' . __( 'Clear', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="submitted" name="submitted"/>' . '</div>' . '</form>' . '</div>'; $IXAP34 .= '</div>'; return $IXAP34; } } Affiliates_Stats_Renderer_WordPress::init();